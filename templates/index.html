<!DOCTYPE html>
<html>
<head>
    <title>Laser Turret Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Laser Turret Control Panel</h1>
            <p>Advanced Camera Control & Monitoring System</p>
        </div>

        <div class="control-layout">
            <section class="video-section">
                <div class="video-wrapper">
                    <img id="video-stream" src="{{ url_for('video_feed') }}" alt="Video stream">

                    <div class="overlay-toolbar">
                        <button id="motors-toggle" class="toolbar-button" onclick="toggleMotorsFromToolbar(this)">
                            Motors
                            <span class="state-pill" id="motors-state">--</span>
                        </button>
                        <button class="toolbar-button active" data-overlay-target="movement" onclick="toggleOverlayPanel('movement-overlay', this)">Movement</button>
                        <button class="toolbar-button" data-overlay-target="objects" onclick="toggleOverlayPanel('objects-overlay', this)">Objects</button>
                        <button class="toolbar-button" data-overlay-target="laser" onclick="toggleOverlayPanel('laser-overlay', this)">Laser</button>
                    </div>

                    <div class="overlay-panel floating-controls movement-overlay active" id="movement-overlay" data-overlay-key="movement">
                        <div class="direction-pad">
                            <span class="spacer"></span>
                            <button class="pad-button" onclick="manualMove('y', -1)" aria-label="Nudge up" title="Nudge up">‚ñ≤</button>
                            <span class="spacer"></span>
                            <button class="pad-button" onclick="manualMove('x', -1)" aria-label="Nudge left" title="Nudge left">‚óÑ</button>
                            <button class="pad-button fire-button" data-fire-control onclick="fireLaser(this)" aria-label="Fire laser" title="Fire laser">
                                <span>Fire</span>
                            </button>
                            <button class="pad-button" onclick="manualMove('x', 1)" aria-label="Nudge right" title="Nudge right">‚ñ∫</button>
                            <span class="spacer"></span>
                            <button class="pad-button" onclick="manualMove('y', 1)" aria-label="Nudge down" title="Nudge down">‚ñº</button>
                            <span class="spacer"></span>
                        </div>
                        <div class="floating-slider overlay-slider">
                            <label for="manual-step-size" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Step Size</span>
                                <span id="manual-step-size-value" class="floating-slider-value overlay-slider-value">100 px</span>
                            </label>
                            <input type="range" id="manual-step-size" min="10" max="500" value="100" step="10" oninput="updateManualStepSize()">
                        </div>
                        <div class="icon-action-row">
                            <button class="icon-action" onclick="setHomePosition()" aria-label="Set current position as home" title="Set current position as home">üìç</button>
                            <button class="icon-action" onclick="homeCameraPosition()" aria-label="Move to saved home position" title="Return to Home">üè†</button>
                            <button class="icon-action" onclick="runAutoCalibration()" aria-label="Run auto calibration" title="Auto Calibration">ü§ñ</button>
                            <button class="icon-action" id="recenter-toggle-btn" onclick="toggleOverlayRecenter(this)" aria-label="Toggle re-center on target loss" title="Re-center on Target Loss">üéØ</button>
                        </div>
                    </div>

                    <div class="overlay-panel laser-overlay" id="laser-overlay" data-overlay-key="laser">
                        <button class="pad-button fire-button" data-fire-control onclick="fireLaser(this)" aria-label="Fire laser" title="Fire laser" style="width: 100%; height: 60px;">
                            <span>Fire</span>
                            <span>Laser</span>
                        </button>
                        <div class="overlay-toggle-grid">
                            <button id="overlay-laser-enable" class="overlay-toggle-chip" onclick="toggleLaserFromOverlay()">Laser System</button>
                            <button id="overlay-auto-fire" class="overlay-toggle-chip" onclick="toggleAutoFireFromOverlay()">Auto Fire</button>
                            <button id="overlay-mock-fire" class="overlay-toggle-chip" onclick="toggleMockFireFromOverlay()">Mock Fire</button>
                        </div>
                        <div class="overlay-status-grid">
                            <div>
                                <span class="overlay-status-label">System</span>
                                <span id="overlay-laser-status" class="overlay-status-value">OFF</span>
                            </div>
                            <div>
                                <span class="overlay-status-label">Ready</span>
                                <span id="overlay-laser-ready" class="overlay-status-value">No</span>
                            </div>
                            <div>
                                <span class="overlay-status-label">Power</span>
                                <span id="overlay-laser-power" class="overlay-status-value">100%</span>
                            </div>
                            <div>
                                <span class="overlay-status-label">Cooldown</span>
                                <span id="overlay-laser-cooldown" class="overlay-status-value">Ready</span>
                            </div>
                        </div>
                    </div>

                    <div class="overlay-panel objects-overlay" id="objects-overlay" data-overlay-key="objects">
                        <div class="overlay-toggle-grid">
                            <button id="overlay-objects-detect" class="overlay-toggle-chip" onclick="toggleObjectDetectionFromOverlay()">Detection</button>
                            <button id="overlay-objects-track" class="overlay-toggle-chip" onclick="toggleObjectAutoTrackFromOverlay()">Auto-Track</button>
                        </div>
                        <div class="overlay-slider">
                            <label for="overlay-object-confidence" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Confidence Threshold</span>
                                <span id="overlay-object-confidence-value" class="overlay-slider-value">0.50</span>
                            </label>
                            <input type="range" id="overlay-object-confidence" min="0.1" max="0.9" step="0.05" value="0.5" oninput="handleOverlayConfidenceInput(this.value)">
                        </div>
                        <div id="overlay-object-hint" class="overlay-empty" style="display: none;">
                            Confidence control unavailable for the current detection method.
                        </div>
                    </div>
                </div>
            </section>

            <aside class="controls-panel">
                <div class="controls-header">
                    <h2>Control Center</h2>
                    <p>Switch between system status, targeting, automation, and imaging tools.</p>
                </div>

                <div class="panel-body">
                    <nav class="tab-navigation">
                        <div class="nav-section">
                            <span class="nav-label">Overview</span>
                            <button class="tab active" data-tab="stats" onclick="switchTab('stats', this)">üìä Status</button>
                        </div>
                        <div class="nav-section">
                            <span class="nav-label">Targeting</span>
                            <button class="tab" data-tab="tracking" onclick="switchTab('tracking', this)">üéØ Tracking</button>
                            <button class="tab" data-tab="laser" onclick="switchTab('laser', this)">üî¥ Laser</button>
                        </div>
                        <div class="nav-section">
                            <span class="nav-label">Automation</span>
                            <button class="tab" data-tab="presets" onclick="switchTab('presets', this)">üìç Presets</button>
                            <button class="tab" data-tab="object" onclick="switchTab('object', this)">üë§ Objects</button>
                            <button class="tab" data-tab="motion" onclick="switchTab('motion', this)">üéØ Motion</button>
                        </div>
                        <div class="nav-section">
                            <span class="nav-label">Imaging</span>
                            <button class="tab" data-tab="exposure" onclick="switchTab('exposure', this)">üîÜ Exposure</button>
                            <button class="tab" data-tab="image" onclick="switchTab('image', this)">üé® Image</button>
                            <button class="tab" data-tab="capture" onclick="switchTab('capture', this)">üì∏ Capture</button>
                        </div>
                    </nav>

                    <div class="tab-content-area">
                        <!-- Stats Tab -->
                        <div id="stats-tab" class="tab-content active">
                    <div class="control-group">
                        <h3>üìç Crosshair Position</h3>
                        <div class="stat-row">
                            <span class="stat-label">Position</span>
                            <span id="position" class="stat-value">Center</span>
                        </div>
                        <button class="btn-secondary" onclick="resetCrosshair()" style="margin-top: 10px;">
                            üéØ Reset to Center
                        </button>
                        <div class="toggle-switch" style="margin-top: 12px;">
                            <label class="switch">
                                <input type="checkbox" id="crosshair-calibration-enabled" onchange="toggleCrosshairCalibration()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Enable Crosshair Calibration</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Calibration Offset (px)</span>
                            <span id="crosshair-offset" class="stat-value">0, 0</span>
                        </div>
                        <button class="btn-secondary" onclick="resetCrosshairCalibration()" style="margin-top: 10px;">
                            üîÑ Reset Calibration
                        </button>
                        <div id="crosshair-calibration-status" class="status-message"></div>
                    </div>

                    <div class="control-group">
                        <h3>‚ö° Performance</h3>
                        <div class="stat-row">
                            <span class="stat-label">Frame Rate</span>
                            <span id="fps" class="stat-value">-- FPS</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Exposure Time</span>
                            <span id="exp-time" class="stat-value">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Analog Gain</span>
                            <span id="gain" class="stat-value">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Digital Gain</span>
                            <span id="digital-gain" class="stat-value">--</span>
                        </div>
                    </div>
                </div>

                <!-- Camera Tracking Tab -->
                <div id="tracking-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üìπ Tracking Mode</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Choose how objects are tracked: move crosshair (software) or move camera (hardware)
                        </p>
                        
                        <div class="select-control">
                            <label>Tracking Mode</label>
                            <select id="tracking-mode" onchange="setTrackingMode()">
                                <option value="crosshair">Crosshair Tracking (Software)</option>
                                <option value="camera">Camera Tracking (Stepper Motors)</option>
                            </select>
                        </div>

                        <div id="tracking-mode-info" style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 6px; font-size: 13px; color: #1565c0;">
                            <strong>Crosshair Mode:</strong> Tracks objects by moving the crosshair on screen. Camera stays fixed.
                        </div>
                    </div>

                    <div id="camera-tracking-controls" style="display: none;">
            <!-- Calibration Required Warning -->
            <div id="calibration-required-warning" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Calibration Required</h3>
                <p style="margin-bottom: 10px;">Camera tracking must be calibrated before use. Please run the Auto-Calibration sequence below.</p>
                <p style="font-size: 12px; opacity: 0.9;">This only needs to be done once. Calibration data will be saved and reloaded on restart.</p>
            </div>

            <div class="control-group">
                <h3>üéÆ Camera Control</h3>
                            
                            <div class="toggle-switch">
                                <label class="switch">
                                    <input type="checkbox" id="camera-tracking-enabled" onchange="toggleCameraTracking()">
                                    <span class="slider"></span>
                                </label>
                                <span class="toggle-label">Enable Camera Movement</span>
                            </div>

                            <div class="toggle-switch">
                                <label class="switch">
                                    <input type="checkbox" id="camera-recenter-on-loss" onchange="toggleRecenterOnLoss()">
                                    <span class="slider"></span>
                                </label>
                                <span class="toggle-label">Re-center camera slowly on target loss</span>
                            </div>

                            <button class="btn-primary" id="home-camera-btn" onclick="homeCameraPosition()" style="margin-top: 10px;">
                                üè† Home Camera to Center
                            </button>

                            <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
                                <strong>‚ö†Ô∏è Important:</strong> Ensure stepper motors are properly connected before enabling camera tracking.
                            </div>
            </div>

            <div class="control-group">
                <h3>üîß Calibration</h3>
                <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                    Automatically find limits and set home position, or manually calibrate steps-per-pixel
                </p>

                <button class="btn-success" onclick="runAutoCalibration()" style="margin-bottom: 15px;">
                    ü§ñ Auto-Calibrate & Home
                </button>

                <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 12px; color: #1565c0;">
                    <strong>Auto-Calibration:</strong> Finds movement limits in all directions, moves to center, and sets home position. May take several minutes.
                </div>

                <div class="slider-control">
                    <label>X-Axis Steps/Pixel</label>
                    <div class="slider-wrapper">
                        <input type="range" id="camera-x-steps-per-pixel" min="0.01" max="1.0" value="0.1" step="0.01" oninput="updateCameraXStepsValue()">
                        <span id="camera-x-steps-value" class="slider-value">0.10</span>
                    </div>
                </div>

                <div class="slider-control">
                    <label>Y-Axis Steps/Pixel</label>
                    <div class="slider-wrapper">
                        <input type="range" id="camera-y-steps-per-pixel" min="0.01" max="1.0" value="0.1" step="0.01" oninput="updateCameraYStepsValue()">
                        <span id="camera-y-steps-value" class="slider-value">0.10</span>
                    </div>
                </div>

                <button class="btn-primary" onclick="applyCameraCalibration()">Save Manual Calibration</button>
            </div>

            <div class="control-group">
                <h3>‚öôÔ∏è Camera Settings</h3>

                <div class="slider-control">
                    <label>Dead Zone (pixels)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="camera-dead-zone" min="5" max="100" value="20" step="5" oninput="updateCameraDeadZoneValue()">
                        <span id="camera-dead-zone-value" class="slider-value">20px</span>
                    </div>
                </div>

                <div class="slider-control">
                    <label>Movement Speed</label>
                    <div class="slider-wrapper">
                        <input type="range" id="camera-step-delay" min="0.0005" max="0.005" value="0.0045" step="0.0005" oninput="updateCameraStepDelayValue()">
                        <span id="camera-step-delay-value" class="slider-value">1.0ms</span>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h3>üìä Camera Status</h3>
                <div class="stat-row">
                    <span class="stat-label">System Status</span>
                    <span id="camera-system-status" class="stat-value">Initializing...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Calibration Status</span>
                    <span id="camera-calibration-status" class="stat-value">Not Calibrated</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Camera Movement Enabled</span>
                    <span id="camera-enabled-status" class="stat-value">No</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Camera Position (X, Y)</span>
                    <span id="camera-position" class="stat-value">0, 0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Crosshair Position (X, Y)</span>
                    <span id="crosshair-position" class="stat-value">0, 0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Moving</span>
                    <span id="camera-moving" class="stat-value">No</span>
                </div>
            </div>
                    </div>

                    <div id="tracking-status-message" class="status-message"></div>
                </div>

                <!-- Laser Control Tab -->
                <div id="laser-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üî¥ Laser System</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="laser-enabled" onchange="toggleLaser()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Enable Laser System</span>
                        </div>

                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="auto-fire-enabled" onchange="toggleAutoFire()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto-Fire on Detection</span>
                        </div>

                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="mock-fire-enabled" onchange="toggleMockFire()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Mock Fire Mode (Visual Only)</span>
                        </div>

                        <button id="fire-button" class="btn-success" data-fire-control onclick="fireLaser(this)" style="font-size: 16px; padding: 15px;">
                            üî¥ FIRE LASER
                        </button>
                    </div>

                    <div class="control-group">
                        <h3>‚öôÔ∏è Fire Settings</h3>

                        <div class="slider-control">
                            <label>Pulse Duration (ms)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="pulse-duration" min="10" max="1000" value="100" step="10" oninput="updatePulseDurationValue()">
                                <span id="pulse-duration-value" class="slider-value">100ms</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Burst Count</label>
                            <div class="slider-wrapper">
                                <input type="range" id="burst-count" min="1" max="10" value="1" step="1" oninput="updateBurstCountValue()">
                                <span id="burst-count-value" class="slider-value">1</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Burst Delay (ms)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="burst-delay" min="50" max="1000" value="100" step="50" oninput="updateBurstDelayValue()">
                                <span id="burst-delay-value" class="slider-value">100ms</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Cooldown (seconds)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="laser-cooldown" min="0.1" max="5" value="0.5" step="0.1" oninput="updateLaserCooldownValue()">
                                <span id="laser-cooldown-value" class="slider-value">0.5s</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>üí° Laser Power (%)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="laser-power" min="0" max="100" value="100" step="5" oninput="updateLaserPowerValue()">
                                <span id="laser-power-value" class="slider-value">100%</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>üéØ Auto-Fire Distance (pixels)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="auto-fire-distance" min="10" max="200" value="50" step="5" oninput="updateAutoFireDistanceValue()">
                                <span id="auto-fire-distance-value" class="slider-value">50px</span>
                            </div>
                        </div>

                        <button class="btn-primary" onclick="applyLaserSettings()">Apply Fire Settings</button>
                    </div>

                    <div class="control-group">
                        <h3>üìä Laser Status</h3>
                        <div class="stat-row">
                            <span class="stat-label">System Status</span>
                            <span id="laser-system-status" class="stat-value">OFF</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Mock Fire Mode</span>
                            <span id="laser-mock-mode" class="stat-value">OFF</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Ready to Fire</span>
                            <span id="laser-ready" class="stat-value">No</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Fires</span>
                            <span id="laser-fire-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Cooldown</span>
                            <span id="laser-cooldown-remaining" class="stat-value">Ready</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Power Level</span>
                            <span id="laser-power-level" class="stat-value">100%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Hardware</span>
                            <span id="laser-hardware-status" class="stat-value">--</span>
                        </div>
                        <button class="btn-secondary" onclick="resetFireCount()" style="margin-top: 10px;">
                            üîÑ Reset Counter
                        </button>
                    </div>

                    <div id="laser-status-message" class="status-message"></div>
                </div>

                <!-- Presets Tab -->
                <div id="presets-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üíæ Save Position</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Save current crosshair position to a slot (1-10)
                        </p>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="save-slot" min="1" max="10" value="1" 
                                   style="width: 60px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            <input type="text" id="preset-label" placeholder="Label (optional)" 
                                   style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>
                        <button class="btn-primary" onclick="savePreset()">üíæ Save to Slot</button>
                    </div>

                    <div class="control-group">
                        <h3>üìç Saved Positions</h3>
                        <div id="preset-list" style="max-height: 200px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 20px;">No presets saved</p>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>üîÑ Pattern Sequence</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Execute sequence of saved positions
                        </p>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #555; font-weight: 600; margin-bottom: 8px; font-size: 13px;">
                                Sequence (comma-separated slots, e.g., 1,2,3,4)
                            </label>
                            <input type="text" id="pattern-sequence" placeholder="ex.: 1,2,3,4" 
                                   style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>

                        <div class="slider-control">
                            <label>Delay Between Positions (seconds)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="pattern-delay" min="0.5" max="5" value="1" step="0.5" oninput="updatePatternDelayValue()">
                                <span id="pattern-delay-value" class="slider-value">1.0s</span>
                            </div>
                        </div>

                        <div class="toggle-switch" style="margin-bottom: 15px;">
                            <label class="switch">
                                <input type="checkbox" id="pattern-loop" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Loop Pattern</span>
                        </div>

                        <button id="start-pattern-btn" class="btn-success" onclick="startPattern()">
                            ‚ñ∂Ô∏è Start Pattern
                        </button>
                        <button id="stop-pattern-btn" class="btn-secondary" onclick="stopPattern()" style="display: none;">
                            ‚èπÔ∏è Stop Pattern
                        </button>
                    </div>

                    <div id="preset-status" class="status-message"></div>
                </div>

                <!-- Object Detection Tab -->
                <div id="object-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üë§ Object Detection</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="object-enabled" onchange="toggleObjectDetection()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Enable Object Detection</span>
                        </div>

                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="object-auto-track-enabled" onchange="toggleObjectAutoTrack()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto-Track Objects</span>
                        </div>

                        <div class="select-control">
                            <label>Target Priority</label>
                            <select id="target-priority" onchange="applyObjectSettings()">
                                <option value="largest">Largest Object</option>
                                <option value="closest">Closest Object</option>
                                <option value="leftmost">Leftmost Object</option>
                                <option value="rightmost">Rightmost Object</option>
                            </select>
                        </div>

                        <div class="select-control">
                            <label>üî¨ Detection Method</label>
                            <select id="detection-method" onchange="switchDetectionMethod()">
                                <option value="haar">Haar Cascades (Fast, Faces Only)</option>
                                <option value="tflite">TensorFlow Lite (Accurate, 80+ Classes)</option>
                                <option value="roboflow">Roboflow Inference (Custom Models)</option>
                            </select>
                            <small style="color: #666; font-size: 11px; display: block; margin-top: 4px;" id="method-info">
                                Haar: 30+ FPS | TFLite: 15-25 FPS | Roboflow: Varies by network/model
                            </small>
                        </div>

                        <div id="haar-settings" style="display: none;">
            <div class="select-control">
                <label>Detection Mode</label>
                <select id="detection-mode" onchange="applyObjectSettings()">
                    <option value="face">Face Detection</option>
                    <option value="eye">Eye Detection</option>
                    <option value="body">Full Body Detection</option>
                    <option value="smile">Smile Detection</option>
                    <option value="balloon">Balloon Detection</option>
                </select>
            </div>
            <div id="balloon-settings" style="display: none; margin-top: 10px;">
                <h4 style="font-size: 14px; color: #333; margin-bottom: 8px;">üéà Balloon Tuning</h4>
                <div class="slider-control">
                    <label>Brightness Threshold (V 0-255)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="balloon-v-threshold" min="0" max="255" value="60" step="5" oninput="updateBalloonVValue()">
                        <span id="balloon-v-value" class="slider-value">60</span>
                    </div>
                </div>
                <div class="slider-control">
                    <label>Minimum Area (pixels)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="balloon-min-area" min="0" max="20000" value="2000" step="100" oninput="updateBalloonMinAreaValue()">
                        <span id="balloon-min-area-value" class="slider-value">2000</span>
                    </div>
                </div>
                <div class="slider-control">
                    <label>Min Circularity (0.00-1.00)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="balloon-circularity" min="0" max="1" value="0.55" step="0.05" oninput="updateBalloonCircularityValue()">
                        <span id="balloon-circularity-value" class="slider-value">0.55</span>
                    </div>
                </div>
                <div class="slider-control">
                    <label>Min Fill Ratio (0.00-1.00)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="balloon-fill" min="0" max="1" value="0.5" step="0.05" oninput="updateBalloonFillValue()">
                        <span id="balloon-fill-value" class="slider-value">0.50</span>
                    </div>
                </div>
                <div class="slider-control">
                    <label>Aspect Ratio Min (w/h)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="balloon-ar-min" min="0" max="2" value="0.6" step="0.05" oninput="updateBalloonARMinValue()">
                        <span id="balloon-ar-min-value" class="slider-value">0.60</span>
                    </div>
                </div>
                <div class="slider-control">
                    <label>Aspect Ratio Max (w/h)</label>
                    <div class="slider-wrapper">
                        <input type="range" id="balloon-ar-max" min="0" max="3" value="1.6" step="0.05" oninput="updateBalloonARMaxValue()">
                        <span id="balloon-ar-max-value" class="slider-value">1.60</span>
                    </div>
                </div>
                <button class="btn-primary" onclick="applyBalloonSettings()">Apply Balloon Settings</button>
            </div>
        </div>

                        <div id="tflite-settings" style="display: none;">
                            <div class="slider-control">
                                <label>
                                    Confidence Threshold 
                                    <span id="tflite-confidence-value" style="color: #667eea;">0.5</span>
                                </label>
                                <input type="range" id="tflite-confidence" min="0.1" max="0.9" step="0.05" value="0.5" 
                                       oninput="updateTFLiteConfidence()">
                                <small style="color: #666; font-size: 11px;">Higher = fewer false positives</small>
                            </div>

                            <div class="input-control">
                                <label>Filter Classes (optional)</label>
                                <input type="text" id="tflite-filter-classes" 
                                       placeholder="e.g., person,cat,dog,bird"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                <small style="color: #666; font-size: 11px; display: block; margin-top: 4px;">
                                    Leave empty for all 80 classes
                                </small>
                            </div>

                            <button onclick="applyTFLiteSettings()" class="btn btn-primary" style="width: 100%; margin-top: 10px; padding: 10px; background: #667eea; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                Apply TFLite Settings
                            </button>
                        </div>

                        <div id="roboflow-settings" style="display: none;">
                            <div class="input-control" style="margin-bottom: 15px;">
                                <label>Server URL</label>
                                <input type="text" id="roboflow-server-url" 
                                       placeholder="http://192.168.1.100:9001"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                <small style="color: #666; font-size: 11px; display: block; margin-top: 4px;">
                                    IP address of the inference server
                                </small>
                            </div>

                            <div class="input-control" style="margin-bottom: 15px;">
                                <label>Model ID</label>
                                <input type="text" id="roboflow-model-id" 
                                       placeholder="project_id/version (e.g., soccer-players-5fuqs/1)"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                <small style="color: #666; font-size: 11px; display: block; margin-top: 4px;">
                                    Format: project_id/version. Find IDs in Roboflow (Project -> API)
                                </small>
                            </div>

                            <div class="input-control" style="margin-bottom: 15px;">
                                <label>API Key (optional)</label>
                                <input type="password" id="roboflow-api-key" 
                                       placeholder="Leave empty for public models"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                            </div>

                            <div class="slider-control">
                                <label>
                                    Confidence Threshold 
                                    <span id="roboflow-confidence-value" style="color: #667eea;">0.5</span>
                                </label>
                                <input type="range" id="roboflow-confidence" min="0.1" max="0.9" step="0.05" value="0.5" 
                                       oninput="updateRoboflowConfidence()">
                                <small style="color: #666; font-size: 11px;">Higher = fewer false positives</small>
                            </div>

                            <div class="input-control" style="margin-bottom: 15px;">
                                <label>Filter Classes (optional)</label>
                                <input type="text" id="roboflow-filter-classes" 
                                       placeholder="e.g., balloon"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                <small style="color: #666; font-size: 11px; display: block; margin-top: 4px;">
                                    Leave empty for all classes
                                </small>
                            </div>

                            <button onclick="applyRoboflowSettings()" class="btn btn-primary">
                                Apply Roboflow Settings
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>üìä Detection Status</h3>
                        <div class="stat-row">
                            <span class="stat-label">Status</span>
                            <span id="object-status" class="stat-value">OFF</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Method</span>
                            <span id="detection-method-display" class="stat-value">Haar Cascades</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Objects Detected</span>
                            <span id="objects-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-row" id="current-mode-row">
                            <span class="stat-label">Current Mode</span>
                            <span id="current-mode" class="stat-value">Face</span>
                        </div>
                        <!-- TFLite Performance Stats -->
                        <div id="tflite-stats" style="display: none;">
                            <div class="stat-row">
                                <span class="stat-label">Inference Time</span>
                                <span id="tflite-inference-time" class="stat-value">--</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Est. FPS</span>
                                <span id="tflite-fps" class="stat-value">--</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Accelerator</span>
                                <span id="tflite-accelerator" class="stat-value">CPU</span>
                            </div>
                        </div>
                        <!-- Roboflow Performance Stats -->
                        <div id="roboflow-stats" style="display: none;">
                            <div class="stat-row">
                                <span class="stat-label">Server URL</span>
                                <span id="roboflow-server-display" class="stat-value">--</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Model ID</span>
                                <span id="roboflow-model-display" class="stat-value">--</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Inference Time</span>
                                <span id="roboflow-inference-time" class="stat-value">--</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Est. FPS</span>
                                <span id="roboflow-fps" class="stat-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div id="object-status-message" class="status-message"></div>
                </div>

                <!-- Motion Detection Tab -->
                <div id="motion-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üéØ Motion Detection</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="motion-enabled" onchange="toggleMotionDetection()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Enable Motion Detection</span>
                        </div>

                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="auto-track-enabled" onchange="toggleAutoTrack()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto-Track Motion</span>
                        </div>

                        <div class="slider-control">
                            <label>Sensitivity (Lower = More Sensitive)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="motion-sensitivity" min="10" max="100" value="25" step="5" oninput="updateSensitivityValue()">
                                <span id="sensitivity-value" class="slider-value">25</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Minimum Area (pixels)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="motion-min-area" min="100" max="5000" value="500" step="100" oninput="updateMinAreaValue()">
                                <span id="min-area-value" class="slider-value">500</span>
                            </div>
                        </div>

                        <button class="btn-primary" onclick="applyMotionSettings()">Apply Settings</button>
                    </div>

                    <div class="control-group">
                        <h3>üìä Motion Status</h3>
                        <div class="stat-row">
                            <span class="stat-label">Detection</span>
                            <span id="motion-status" class="stat-value">OFF</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Motion Detected</span>
                            <span id="motion-detected" class="stat-value">No</span>
                        </div>
                    </div>

                    <div id="motion-status-message" class="status-message"></div>
                </div>

                <!-- Exposure Tab -->
                <div id="exposure-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üîÜ Exposure Control</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="auto-exposure" checked onchange="toggleAutoExposure()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto Exposure</span>
                        </div>

                        <div id="manual-exposure-controls" style="display: none;">
                            <div class="slider-control">
                                <label>Exposure Time (¬µs)</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="exposure-time" min="1000" max="200000" value="20000" step="1000" oninput="updateExposureValue()">
                                    <span id="exposure-time-value" class="slider-value">20000</span>
                                </div>
                            </div>

                            <div class="slider-control">
                                <label>Analog Gain</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="analog-gain" min="1" max="16" value="1" step="0.1" oninput="updateAnalogGainValue()">
                                    <span id="analog-gain-value" class="slider-value">1.0</span>
                                </div>
                            </div>

                            <div class="slider-control">
                                <label>Digital Gain</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="digital-gain" min="1" max="8" value="1" step="0.1" oninput="updateDigitalGainValue()">
                                    <span id="digital-gain-value" class="slider-value">1.0</span>
                                </div>
                            </div>

                            <button class="btn-primary" onclick="applyExposure()">Apply Exposure Settings</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>‚öñÔ∏è White Balance</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="auto-wb" checked onchange="toggleAutoWB()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto White Balance</span>
                        </div>

                        <div class="select-control" id="wb-mode-control" style="display: none;">
                            <label>WB Mode</label>
                            <select id="wb-mode" onchange="applyWhiteBalance()">
                                <option value="0">Auto</option>
                                <option value="1">Incandescent</option>
                                <option value="2">Tungsten</option>
                                <option value="3">Fluorescent</option>
                                <option value="4">Indoor</option>
                                <option value="5">Daylight</option>
                                <option value="6">Cloudy</option>
                            </select>
                        </div>
                    </div>

                    <div id="exposure-status" class="status-message"></div>
                </div>

                <!-- Image Tab -->
                <div id="image-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üé® Image Adjustments</h3>

                        <div class="slider-control">
                            <label>Brightness</label>
                            <div class="slider-wrapper">
                                <input type="range" id="brightness" min="-1" max="1" value="0" step="0.1" oninput="updateBrightnessValue()">
                                <span id="brightness-value" class="slider-value">0.0</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Contrast</label>
                            <div class="slider-wrapper">
                                <input type="range" id="contrast" min="0" max="2" value="1" step="0.1" oninput="updateContrastValue()">
                                <span id="contrast-value" class="slider-value">1.0</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Saturation</label>
                            <div class="slider-wrapper">
                                <input type="range" id="saturation" min="0" max="2" value="1" step="0.1" oninput="updateSaturationValue()">
                                <span id="saturation-value" class="slider-value">1.0</span>
                            </div>
                        </div>

                        <button class="btn-primary" onclick="applyImageParams()">Apply Image Settings</button>
                        <button class="btn-secondary" onclick="resetImageParams()">Reset to Defaults</button>
                    </div>

                    <div id="image-status" class="status-message"></div>
                </div>

                <!-- Capture Tab -->
                <div id="capture-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üì∏ Image Capture</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Capture high-quality still images from the camera feed.
                        </p>
                        <button class="btn-success" onclick="captureImage()">üì∑ Capture Image</button>
                    </div>

                    <div id="capture-status" class="status-message"></div>

                    <div class="control-group">
                        <h3>üé• Video Recording</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Record live video feed to MP4 file with timestamp.
                        </p>
                        
                        <div id="recording-info" style="display: none; margin-bottom: 15px;">
                            <div class="stat-row">
                                <span class="stat-label">Status</span>
                                <span class="stat-value" style="color: #dc3545;">‚óè Recording</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Duration</span>
                                <span id="recording-duration" class="stat-value">00:00</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Filename</span>
                                <span id="recording-filename" class="stat-value" style="font-size: 11px;">--</span>
                            </div>
                        </div>

                        <button id="start-recording-btn" class="btn-primary" onclick="startRecording()">
                            ‚è∫Ô∏è Start Recording
                        </button>
                        <button id="stop-recording-btn" class="btn-secondary" onclick="stopRecording()" style="display: none;">
                            ‚èπÔ∏è Stop Recording
                        </button>
                    </div>

                    <div id="recording-status" class="status-message"></div>
                </div>
            </div>
        </aside>
    </div>
</div>

    <script>
        const CAMERA_WIDTH = 1920;
        const CAMERA_HEIGHT = 1080;
        let crosshairCalibrationMode = false;

        // Editing guards to avoid UI snapping back during WebSocket updates
        const EDIT_IDLE_MS = 1500;
        let tfliteEditing = false;
        let tfliteLastEditTs = 0;
        let roboflowEditing = false;
        let roboflowLastEditTs = 0;
        let balloonEditing = false;
        let balloonLastEditTs = 0;
        let pidEditing = false;
        let pidLastEditTs = 0;

        // Tab switching
        function switchTab(tabName, buttonEl) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const targetContent = document.getElementById(`${tabName}-tab`);
            if (targetContent) {
                targetContent.classList.add('active');
            }

            const targetButton = buttonEl || document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            // If leaving Object tab, make sure method-specific panels are hidden
            if (tabName !== 'object') {
                ['haar-settings','tflite-settings','roboflow-settings','current-mode-row','tflite-stats','roboflow-stats']
                    .forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
            } else {
                // Refresh object status to show appropriate panel for selected method
                updateObjectStatus();
            }
        }

        // Crosshair positioning with camera movement support
        document.getElementById('video-stream').addEventListener('click', function(e) {
            const rect = this.getBoundingClientRect();
            const scaleX = CAMERA_WIDTH / this.offsetWidth;
            const scaleY = CAMERA_HEIGHT / this.offsetHeight;
            const clickX = (e.clientX - rect.left);
            const clickY = (e.clientY - rect.top);
            const cameraX = Math.round(clickX * scaleX);
            const cameraY = Math.round(clickY * scaleY);
            
            if (crosshairCalibrationMode) {
                fetch('/crosshair/calibration/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x: cameraX, y: cameraY })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('position').textContent = `X: ${data.absolute.x}, Y: ${data.absolute.y}`;
                        const off = data.offset;
                        document.getElementById('crosshair-offset').textContent = `${off.x}, ${off.y}`;
                        showStatus('crosshair-calibration-status', true, 'Calibration updated');
                    } else {
                        showStatus('crosshair-calibration-status', false, data.message || 'Failed to set calibration');
                    }
                })
                .catch(error => {
                    console.error('Error setting calibration:', error);
                    showStatus('crosshair-calibration-status', false, 'Failed to set calibration');
                });
                return;
            }

            // Check if camera tracking is enabled and active
            const trackingMode = document.getElementById('tracking-mode').value;
            const cameraTrackingEnabled = document.getElementById('camera-tracking-enabled').checked;
            
            if (trackingMode === 'camera' && cameraTrackingEnabled) {
                // Camera movement mode: move camera to recenter clicked position
                // Crosshair stays centered, don't update position display
                fetch('/tracking/camera/move_to_position', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x: cameraX, y: cameraY })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Visual feedback
                        showStatus('tracking-status-message', true, 'Camera moving to recenter position...');
                    } else {
                        showStatus('tracking-status-message', false, data.message);
                    }
                })
                .catch(error => {
                    console.error('Error moving camera to position:', error);
                    showStatus('tracking-status-message', false, 'Failed to move camera');
                });
            } else {
                // Crosshair mode: update crosshair position
                document.getElementById('position').textContent = `X: ${cameraX}, Y: ${cameraY}`;
                fetch('/update_crosshair', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x: cameraX, y: cameraY })
                });
            }
        });

        // Reset crosshair to center
        function resetCrosshair() {
            fetch('/reset_crosshair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('position').textContent = `X: ${data.x}, Y: ${data.y}`;
                }
            })
            .catch(error => console.error('Error resetting crosshair:', error));
        }

        function toggleCrosshairCalibration() {
            const enabled = document.getElementById('crosshair-calibration-enabled').checked;
            crosshairCalibrationMode = enabled;
            showStatus('crosshair-calibration-status', true, enabled ? 'Calibration mode ON. Click video to set default crosshair.' : 'Calibration mode OFF');
        }

        function resetCrosshairCalibration() {
            fetch('/crosshair/calibration/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const off = data.offset || {x:0,y:0};
                    document.getElementById('crosshair-offset').textContent = `${off.x}, ${off.y}`;
                    document.getElementById('position').textContent = `X: ${data.absolute.x}, Y: ${data.absolute.y}`;
                    showStatus('crosshair-calibration-status', true, 'Calibration reset');
                } else {
                    showStatus('crosshair-calibration-status', false, data.message || 'Failed to reset calibration');
                }
            })
            .catch(error => {
                console.error('Error resetting calibration:', error);
                showStatus('crosshair-calibration-status', false, 'Failed to reset calibration');
            });
        }

        function updateCrosshairCalibration() {
            fetch('/crosshair/calibration')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.offset) {
                        document.getElementById('crosshair-offset').textContent = `${data.offset.x}, ${data.offset.y}`;
                    }
                })
                .catch(error => console.error('Error fetching crosshair calibration:', error));
        }

        // Exposure controls
        function toggleAutoExposure() {
            const autoEnabled = document.getElementById('auto-exposure').checked;
            document.getElementById('manual-exposure-controls').style.display = autoEnabled ? 'none' : 'block';
            fetch('/set_exposure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auto: autoEnabled })
            })
            .then(response => response.json())
            .then(data => showStatus('exposure-status', data.status === 'success', 
                autoEnabled ? 'Auto exposure enabled' : 'Manual exposure mode'));
        }

        function updateExposureValue() {
            const value = document.getElementById('exposure-time').value;
            document.getElementById('exposure-time-value').textContent = value;
        }

        function updateAnalogGainValue() {
            const value = parseFloat(document.getElementById('analog-gain').value).toFixed(1);
            document.getElementById('analog-gain-value').textContent = value;
        }

        function updateDigitalGainValue() {
            const value = parseFloat(document.getElementById('digital-gain').value).toFixed(1);
            document.getElementById('digital-gain-value').textContent = value;
        }

        function applyExposure() {
            const exposureTime = parseInt(document.getElementById('exposure-time').value);
            const analogGain = parseFloat(document.getElementById('analog-gain').value);
            const digitalGain = parseFloat(document.getElementById('digital-gain').value);
            fetch('/set_exposure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    auto: false,
                    exposure_time: exposureTime,
                    analog_gain: analogGain,
                    digital_gain: digitalGain
                })
            })
            .then(response => response.json())
            .then(data => showStatus('exposure-status', data.status === 'success', 
                data.status === 'success' ? 'Exposure settings applied' : data.message));
        }

        // White balance controls
        function toggleAutoWB() {
            const autoEnabled = document.getElementById('auto-wb').checked;
            document.getElementById('wb-mode-control').style.display = autoEnabled ? 'none' : 'block';
            fetch('/set_white_balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auto: autoEnabled })
            })
            .then(response => response.json())
            .then(data => showStatus('exposure-status', data.status === 'success',
                autoEnabled ? 'Auto white balance enabled' : 'Manual white balance mode'));
        }

        function applyWhiteBalance() {
            const mode = parseInt(document.getElementById('wb-mode').value);
            fetch('/set_white_balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auto: false, mode: mode })
            })
            .then(response => response.json())
            .then(data => showStatus('exposure-status', data.status === 'success',
                data.status === 'success' ? 'White balance applied' : data.message));
        }

        // Image adjustment controls
        function updateBrightnessValue() {
            const value = parseFloat(document.getElementById('brightness').value).toFixed(1);
            document.getElementById('brightness-value').textContent = value;
        }

        function updateContrastValue() {
            const value = parseFloat(document.getElementById('contrast').value).toFixed(1);
            document.getElementById('contrast-value').textContent = value;
        }

        function updateSaturationValue() {
            const value = parseFloat(document.getElementById('saturation').value).toFixed(1);
            document.getElementById('saturation-value').textContent = value;
        }

        function applyImageParams() {
            const brightness = parseFloat(document.getElementById('brightness').value);
            const contrast = parseFloat(document.getElementById('contrast').value);
            const saturation = parseFloat(document.getElementById('saturation').value);
            fetch('/set_image_params', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    brightness: brightness,
                    contrast: contrast,
                    saturation: saturation
                })
            })
            .then(response => response.json())
            .then(data => showStatus('image-status', data.status === 'success',
                data.status === 'success' ? 'Image settings applied' : data.message));
        }

        function resetImageParams() {
            document.getElementById('brightness').value = 0;
            document.getElementById('contrast').value = 1;
            document.getElementById('saturation').value = 1;
            updateBrightnessValue();
            updateContrastValue();
            updateSaturationValue();
            applyImageParams();
        }

        // Image capture
        function captureImage() {
            fetch('/capture_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => showStatus('capture-status', data.status === 'success',
                data.status === 'success' ? `Image saved: ${data.filename}` : data.message));
        }

        // Status message display
        function showStatus(elementId, success, message) {
            const statusEl = document.getElementById(elementId);
            if (statusEl) {
                statusEl.className = 'status-message ' + (success ? 'status-success' : 'status-error');
                statusEl.textContent = message;
                statusEl.style.display = 'block';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
            showToast(success, message, 3000);
        }

        function ensureToastContainer() {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            return container;
        }

        function showToast(success, message, duration = 3000) {
            const container = ensureToastContainer();
            const toast = document.createElement('div');
            toast.className = 'toast ' + (success ? 'toast-success' : 'toast-error');
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode === container) {
                    container.removeChild(toast);
                }
            }, Math.max(1000, duration));
        }

        // Video recording controls
        function startRecording() {
            fetch('/start_recording', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('start-recording-btn').style.display = 'none';
                    document.getElementById('stop-recording-btn').style.display = 'block';
                    document.getElementById('recording-info').style.display = 'block';
                    document.getElementById('recording-filename').textContent = data.filename;
                    showStatus('recording-status', true, 'Recording started');
                } else {
                    showStatus('recording-status', false, data.message);
                }
            })
            .catch(error => {
                showStatus('recording-status', false, 'Failed to start recording');
                console.error('Error starting recording:', error);
            });
        }

        function stopRecording() {
            fetch('/stop_recording', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('start-recording-btn').style.display = 'block';
                    document.getElementById('stop-recording-btn').style.display = 'none';
                    document.getElementById('recording-info').style.display = 'none';
                    const duration = data.duration ? `${Math.floor(data.duration)}s` : '';
                    showStatus('recording-status', true, 
                        `Recording saved: ${data.filename} (${duration})`);
                } else {
                    showStatus('recording-status', false, data.message);
                }
            })
            .catch(error => {
                showStatus('recording-status', false, 'Failed to stop recording');
                console.error('Error stopping recording:', error);
            });
        }

        function updateRecordingStatus() {
            fetch('/recording_status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.is_recording) {
                        // Update duration display
                        const duration = Math.floor(data.duration);
                        const minutes = Math.floor(duration / 60);
                        const seconds = duration % 60;
                        document.getElementById('recording-duration').textContent = 
                            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        
                        // Ensure UI is in recording state
                        document.getElementById('start-recording-btn').style.display = 'none';
                        document.getElementById('stop-recording-btn').style.display = 'block';
                        document.getElementById('recording-info').style.display = 'block';
                        document.getElementById('recording-filename').textContent = data.filename;
                    }
                })
                .catch(error => console.error('Error checking recording status:', error));
        }

        // Laser control functions
        function toggleLaser() {
            const enabled = document.getElementById('laser-enabled').checked;
            fetch('/laser/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, 
                        enabled ? 'Laser system enabled' : 'Laser system disabled');
                    updateLaserStatus();
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to toggle laser');
                console.error('Error toggling laser:', error);
            });
        }

        function toggleAutoFire() {
            const enabled = document.getElementById('auto-fire-enabled').checked;
            fetch('/laser/auto_fire', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, 
                        enabled ? 'Auto-fire enabled' : 'Auto-fire disabled');
                    updateLaserStatus();
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to toggle auto-fire');
                console.error('Error toggling auto-fire:', error);
            });
        }

        function toggleMockFire() {
            const enabled = document.getElementById('mock-fire-enabled').checked;
            fetch('/laser/mock_fire', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, 
                        enabled ? 'Mock fire mode enabled - Visual feedback only' : 'Mock fire mode disabled');
                    updateLaserStatus();
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to toggle mock fire');
                console.error('Error toggling mock fire:', error);
            });
        }

        function fireLaser(triggerButton) {
            const fireButtons = Array.from(document.querySelectorAll('[data-fire-control]'));
            if (triggerButton instanceof HTMLElement && !fireButtons.includes(triggerButton)) {
                fireButtons.push(triggerButton);
            }
            if (!isLaserEnabled) {
                showStatus('laser-status-message', false, 'Enable the Laser system before firing.');
                return;
            }
            if (!isLaserReadyToFire) {
                showStatus('laser-status-message', false, 'Laser is not ready to fire yet.');
                return;
            }
            fireButtons.forEach(btn => btn.disabled = true);
            fetch('/laser/fire', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, data.message);
                    updateLaserStatus();
                } else {
                    showStatus('laser-status-message', false, data.message);
                    fireButtons.forEach(btn => btn.disabled = false);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to fire laser');
                console.error('Error firing laser:', error);
                fireButtons.forEach(btn => btn.disabled = false);
            });
        }

        function updatePulseDurationValue() {
            const value = document.getElementById('pulse-duration').value;
            document.getElementById('pulse-duration-value').textContent = value + 'ms';
        }

        function updateBurstCountValue() {
            const value = document.getElementById('burst-count').value;
            document.getElementById('burst-count-value').textContent = value;
        }

        function updateBurstDelayValue() {
            const value = document.getElementById('burst-delay').value;
            document.getElementById('burst-delay-value').textContent = value + 'ms';
        }

        function updateLaserCooldownValue() {
            const value = parseFloat(document.getElementById('laser-cooldown').value).toFixed(1);
            document.getElementById('laser-cooldown-value').textContent = value + 's';
        }

        function updateLaserPowerValue() {
            const value = parseInt(document.getElementById('laser-power').value);
            document.getElementById('laser-power-value').textContent = value + '%';
        }

        function updateAutoFireDistanceValue() {
            const value = parseInt(document.getElementById('auto-fire-distance').value);
            document.getElementById('auto-fire-distance-value').textContent = value + 'px';
        }

        function applyLaserSettings() {
            const pulseDuration = parseFloat(document.getElementById('pulse-duration').value) / 1000;
            const burstCount = parseInt(document.getElementById('burst-count').value);
            const burstDelay = parseFloat(document.getElementById('burst-delay').value) / 1000;
            const cooldown = parseFloat(document.getElementById('laser-cooldown').value);
            const power = parseInt(document.getElementById('laser-power').value);
            const autoFireDistance = parseInt(document.getElementById('auto-fire-distance').value);
            
            fetch('/laser/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pulse_duration: pulseDuration,
                    burst_count: burstCount,
                    burst_delay: burstDelay,
                    cooldown: cooldown,
                    power: power,
                    auto_fire_distance_threshold: autoFireDistance
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, `Laser settings applied (Power: ${data.power}%)`);
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to apply laser settings');
                console.error('Error applying laser settings:', error);
            });
        }

        function updateLaserStatus() {
            fetch('/laser/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('laser-system-status').textContent =
                            data.enabled ? 'ON' : 'OFF';
                        document.getElementById('laser-mock-mode').textContent =
                            data.mock_fire_mode ? 'ON (Visual Only)' : 'OFF';
                        document.getElementById('laser-ready').textContent =
                            data.ready_to_fire ? 'Yes' : 'No';
                        document.getElementById('laser-fire-count').textContent = 
                            data.fire_count;
                        
                        if (data.cooldown_remaining > 0) {
                            document.getElementById('laser-cooldown-remaining').textContent = 
                                data.cooldown_remaining.toFixed(1) + 's';
                        } else {
                            document.getElementById('laser-cooldown-remaining').textContent = 'Ready';
                        }
                        
                        if (data.power !== undefined) {
                            document.getElementById('laser-power-level').textContent = data.power + '%';
                        }
                        document.getElementById('laser-hardware-status').textContent = 
                            data.hardware_available ? 'Connected' : 'Simulation';

                        document.getElementById('laser-enabled').checked = data.enabled;
                        document.getElementById('auto-fire-enabled').checked = data.auto_fire;
                        document.getElementById('mock-fire-enabled').checked = data.mock_fire_mode || false;

                        isLaserEnabled = !!data.enabled;
                        isLaserReadyToFire = !!(data.ready_to_fire && data.enabled);
                        const fireReady = isLaserReadyToFire;
                        document.querySelectorAll('[data-fire-control]').forEach(btn => {
                            btn.disabled = false;
                            btn.dataset.fireReady = fireReady ? '1' : '0';
                        });

                        syncLaserOverlay(data);
                    }
                })
                .catch(error => console.error('Error fetching laser status:', error));
        }

        function resetFireCount() {
            if (!confirm('Reset fire counter to 0?')) return;
            
            fetch('/laser/reset_count', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, 'Fire counter reset');
                    updateLaserStatus();
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to reset counter');
                console.error('Error resetting counter:', error);
            });
        }
        // ============================================================
        // WebSocket Communication Setup
        // ============================================================

        // Connect to Socket.IO server
        const socket = io();

        // Handle connection events
        socket.on('connect', () => {
            console.log('WebSocket connected');
        });

        socket.on('disconnect', () => {
            console.warn('WebSocket disconnected');
        });

        socket.on('connect_error', (error) => {
            console.error('WebSocket connection error:', error);
        });

        // Helper function to safely update DOM elements
        function safeUpdateElement(id, value) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
            }
        }

        // Listen for consolidated status updates from server
        socket.on('status_update', (status) => {
            // Update FPS
            if (status.fps !== undefined) {
                safeUpdateElement('fps', `${status.fps} FPS`);
            }

            // Update exposure stats
            if (status.exposure) {
                safeUpdateElement('exp-time', `${(status.exposure.exposure_time/1000).toFixed(1)} ms`);
                safeUpdateElement('gain', `${status.exposure.analog_gain.toFixed(2)}x`);
                if (status.exposure.digital_gain !== undefined) {
                    safeUpdateElement('digital-gain', `${status.exposure.digital_gain.toFixed(2)}x`);
                }
            }

            // Update crosshair position
            if (status.crosshair) {
                const relX = status.crosshair.relative_x;
                const relY = status.crosshair.relative_y;
                safeUpdateElement('position', `(${relX >= 0 ? '+' : ''}${relX}, ${relY >= 0 ? '+' : ''}${relY})`);
                safeUpdateElement('crosshair-position', `${status.crosshair.absolute_x}, ${status.crosshair.absolute_y}`);
            }

            // Update crosshair calibration
            if (status.crosshair_calibration) {
                safeUpdateElement('crosshair-offset', `${status.crosshair_calibration.x}, ${status.crosshair_calibration.y}`);
            }

            // Update laser status
            if (status.laser) {
                if (status.laser.enabled) {
                    document.getElementById('laser-system-status').textContent = 'ON';
                } else {
                    document.getElementById('laser-system-status').textContent = 'OFF';
                }
                document.getElementById('laser-mock-mode').textContent =
                    status.laser.mock_fire_mode ? 'ON (Visual Only)' : 'OFF';
                document.getElementById('laser-ready').textContent =
                    status.laser.ready_to_fire ? 'Yes' : 'No';
                document.getElementById('laser-fire-count').textContent = 
                    status.laser.fire_count;

                if (status.laser.cooldown_remaining > 0) {
                    document.getElementById('laser-cooldown-remaining').textContent = 
                        status.laser.cooldown_remaining.toFixed(1) + 's';
                } else {
                    document.getElementById('laser-cooldown-remaining').textContent = 'Ready';
                }

                if (status.laser.power !== undefined) {
                    document.getElementById('laser-power-level').textContent = status.laser.power + '%';
                }
                document.getElementById('laser-hardware-status').textContent = 
                    status.laser.hardware_available ? 'Connected' : 'Simulation';

                document.getElementById('laser-enabled').checked = status.laser.enabled;
                document.getElementById('auto-fire-enabled').checked = status.laser.auto_fire;
                document.getElementById('mock-fire-enabled').checked = status.laser.mock_fire_mode || false;

                isLaserEnabled = !!status.laser.enabled;
                isLaserReadyToFire = !!(status.laser.ready_to_fire && status.laser.enabled);
                const fireReady = isLaserReadyToFire;
                document.querySelectorAll('[data-fire-control]').forEach(btn => {
                    btn.disabled = false;
                    btn.dataset.fireReady = fireReady ? '1' : '0';
                });

                syncLaserOverlay(status.laser);
            }

            // Update object detection status
            if (status.object_detection) {
                const objEnabled = status.object_detection.enabled;
                const objAutoTrack = status.object_detection.auto_track;
                const objCount = status.object_detection.count;
                const objMode = status.object_detection.mode;
                const objMethod = status.object_detection.method;

                safeUpdateElement('object-detection-status', objEnabled ? 'Enabled' : 'Disabled');
                safeUpdateElement('object-auto-track-status', objAutoTrack ? 'Yes' : 'No');
                safeUpdateElement('object-count', objCount);
                safeUpdateElement('object-detection-mode', objMode ? objMode.toUpperCase() : 'N/A');
                safeUpdateElement('detection-method-display', objMethod ? objMethod.toUpperCase() : 'N/A');

                const detectBtn = document.getElementById('overlay-objects-detect');
                if (detectBtn) detectBtn.classList.toggle('active', !!objEnabled);
                const trackBtn = document.getElementById('overlay-objects-track');
                if (trackBtn) trackBtn.classList.toggle('active', !!objAutoTrack);
                syncOverlayConfidenceFromMain();
            }
            
            // Update motion detection status
            if (status.motion_detection) {
                const motionEnabled = status.motion_detection.enabled;
                const motionAutoTrack = status.motion_detection.auto_track;
                const hasMotion = status.motion_detection.has_motion;
                
                safeUpdateElement('motion-detection-status', motionEnabled ? 'Enabled' : 'Disabled');
                safeUpdateElement('motion-auto-track-status', motionAutoTrack ? 'Yes' : 'No');
                safeUpdateElement('motion-detected', hasMotion ? 'Yes' : 'No');
            }
            
            // Update recording status
            if (status.recording) {
                safeUpdateElement('recording-status', status.recording.is_recording ? 'Recording' : 'Not Recording');
                if (status.recording.is_recording) {
                    const duration = Math.floor(status.recording.duration);
                    const mins = Math.floor(duration / 60);
                    const secs = duration % 60;
                    safeUpdateElement('recording-duration', `${mins}:${secs.toString().padStart(2, '0')}`);
                }
                if (status.recording.filename) {
                    safeUpdateElement('recording-filename', status.recording.filename);
                }
            }
            
            // Update pattern status
            if (status.pattern) {
                safeUpdateElement('pattern-status', status.pattern.running ? 'Running' : 'Stopped');
            }
            
            // Update tracking mode status
            if (status.tracking) {
                const trackMode = document.getElementById('tracking-mode');
                if (trackMode && trackMode.value !== status.tracking.mode) {
                    trackMode.value = status.tracking.mode;
                    updateTrackingModeUI(status.tracking.mode);
                }
            }
            
            // Update camera controller status (detailed)
            if (status.controller) {
                const ctrl = status.controller;
                
                safeUpdateElement('camera-system-status', 'Available');
                safeUpdateElement('camera-enabled-status', status.tracking.camera_enabled ? 'Yes' : 'No');
                
                // Update re-center on loss toggle
                const recenterEl = document.getElementById('camera-recenter-on-loss');
                if (recenterEl) {
                    recenterEl.checked = !!status.tracking.recenter_on_loss;
                }
                
                if (ctrl.position) {
                    safeUpdateElement('camera-position', `${ctrl.position.x}, ${ctrl.position.y}`);
                }
                
                safeUpdateElement('camera-moving', ctrl.moving ? 'Yes' : 'No');
                
                // Initialize calibration sliders ONLY on first load
                if (ctrl.calibration && !calibrationSlidersInitialized) {
                    const xStepsEl = document.getElementById('camera-x-steps-per-pixel');
                    const xStepsValEl = document.getElementById('camera-x-steps-value');
                    const yStepsEl = document.getElementById('camera-y-steps-per-pixel');
                    const yStepsValEl = document.getElementById('camera-y-steps-value');
                    const deadZoneEl = document.getElementById('camera-dead-zone');
                    const stepDelayEl = document.getElementById('camera-step-delay');
                    
                    if (xStepsEl && xStepsValEl) {
                        xStepsEl.value = ctrl.calibration.x_steps_per_pixel;
                        xStepsValEl.textContent = ctrl.calibration.x_steps_per_pixel.toFixed(2);
                    }
                    
                    if (yStepsEl && yStepsValEl) {
                        yStepsEl.value = ctrl.calibration.y_steps_per_pixel;
                        yStepsValEl.textContent = ctrl.calibration.y_steps_per_pixel.toFixed(2);
                    }
                    
                    if (deadZoneEl) {
                        deadZoneEl.value = ctrl.calibration.dead_zone_pixels;
                        updateCameraDeadZoneValue();
                    }
                    
                    if (stepDelayEl && typeof ctrl.calibration.step_delay === 'number') {
                        let sliderVal = 0.0055 - ctrl.calibration.step_delay;
                        sliderVal = Math.max(0.0005, Math.min(0.005, sliderVal));
                        stepDelayEl.value = sliderVal;
                        updateCameraStepDelayValue();
                    }
                    
                    calibrationSlidersInitialized = true;
                }
                
                // Update calibration status UI
                if (ctrl.calibration) {
                    updateCalibrationUI(
                        ctrl.calibration.is_calibrated,
                        ctrl.calibration.calibration_timestamp
                    );
                }
                
                // Sync PID sliders with controller values (with edit protection)
                if (ctrl.pid) {
                    const now = Date.now();
                    const allowPIDSync = !pidEditing || (now - pidLastEditTs > EDIT_IDLE_MS);
                    if (allowPIDSync) {
                        const kpEl = document.getElementById('pid-kp');
                        const kiEl = document.getElementById('pid-ki');
                        const kdEl = document.getElementById('pid-kd');
                        const kpVal = document.getElementById('pid-kp-value');
                        const kiVal = document.getElementById('pid-ki-value');
                        const kdVal = document.getElementById('pid-kd-value');
                        if (kpEl && kpVal) { kpEl.value = ctrl.pid.kp; kpVal.textContent = parseFloat(ctrl.pid.kp).toFixed(2); }
                        if (kiEl && kiVal) { kiEl.value = ctrl.pid.ki; kiVal.textContent = parseFloat(ctrl.pid.ki).toFixed(2); }
                        if (kdEl && kdVal) { kdEl.value = ctrl.pid.kd; kdVal.textContent = parseFloat(ctrl.pid.kd).toFixed(2); }
                    }
                }
                
                const camTrackEl = document.getElementById('camera-tracking-enabled');
                if (camTrackEl) {
                    camTrackEl.checked = status.tracking.camera_enabled;
                }
                syncMotorsToolbar(!!status.tracking.camera_enabled);
                syncRecenterOverlayButton();
            } else if (status.tracking && !status.tracking.camera_enabled) {
                safeUpdateElement('camera-system-status', 'Not Available');
                safeUpdateElement('camera-enabled-status', 'N/A');
                syncMotorsToolbar(false);
                syncRecenterOverlayButton();
            }
        });
        
        // ============================================================
        // Page Initialization
        // ============================================================
        
        async function initializeDetectionMethodFromConfig() {
            try {
                const resp = await fetch('/detection_method/config');
                const data = await resp.json();
                if (data && data.status === 'success' && data.method) {
                    // Ask backend to switch to configured method to ensure detectors are initialized
                    await fetch('/detection_method/switch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ method: data.method })
                    }).then(r => r.json()).catch(() => ({}));
                }
            } catch (e) {
                console.warn('Failed to initialize detection method from config:', e);
            }
        }

        (async () => {
            // Load presets on page load
            loadPresetList();

            // Sync sliders on page load (not from WebSocket)
            syncMotionSliders();
            syncLaserSliders();

            // Initialize camera step delay display
            updateCameraStepDelayValue();
            updateManualStepSize();
            syncOverlayConfidenceFromMain();
            syncRecenterOverlayButton();

            // Ensure backend detection method matches config before status pulls
            await initializeDetectionMethodFromConfig();

            updateLaserStatus();
            updateObjectStatus();
            updateCameraTrackingStatus();
        })();

        console.log('üöÄ Laser Turret Control Panel initialized with WebSocket support');
    </script>
</body>
</html>

