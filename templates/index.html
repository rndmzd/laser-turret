<!DOCTYPE html>
<html>
<head>
    <title>Laser Turret Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            align-items: start;
            max-width: 1400px;
            margin: 0 auto;
        }

        .video-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        #video-stream {
            width: 100%;
            height: auto;
            border-radius: 8px;
            cursor: crosshair;
            display: block;
        }

        .controls-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            justify-content: space-between;
            gap: 3px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            flex: 1;
            text-align: center;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .control-group h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        .stat-value {
            color: #333;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .slider-control {
            margin-bottom: 15px;
        }

        .slider-control label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #5568d3;
            transform: scale(1.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 60px;
            text-align: right;
            font-weight: 600;
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .toggle-label {
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }

        button {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .status-message {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .select-control {
            margin-bottom: 15px;
        }

        .select-control label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .preset-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .preset-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .preset-info {
            flex: 1;
        }

        .preset-slot {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .preset-label {
            color: #333;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .preset-coords {
            color: #666;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }

        .preset-actions {
            display: flex;
            gap: 5px;
        }

        .preset-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn-load {
            background: #667eea;
            color: white;
        }

        .preset-btn-load:hover {
            background: #5568d3;
        }

        .preset-btn-delete {
            background: #dc3545;
            color: white;
        }

        .preset-btn-delete:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Laser Turret Control Panel</h1>
            <p>Advanced Camera Control & Monitoring System</p>
        </div>

        <div class="main-grid">
            <div class="video-section">
                <img id="video-stream" src="{{ url_for('video_feed') }}" alt="Video stream">
            </div>

            <div class="controls-panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('stats')">üìä Stats</button>
                    <button class="tab" onclick="switchTab('tracking')">üìπ Track</button>
                    <button class="tab" onclick="switchTab('laser')">üî¥ Laser</button>
                    <button class="tab" onclick="switchTab('presets')">üìç Presets</button>
                    <button class="tab" onclick="switchTab('object')">üë§ Objects</button>
                    <button class="tab" onclick="switchTab('motion')">üéØ Motion</button>
                    <button class="tab" onclick="switchTab('exposure')">üîÜ Exposure</button>
                    <button class="tab" onclick="switchTab('image')">üé® Image</button>
                    <button class="tab" onclick="switchTab('capture')">üì∏ Capture</button>
                </div>

                <!-- Stats Tab -->
                <div id="stats-tab" class="tab-content active">
                    <div class="control-group">
                        <h3>üìç Crosshair Position</h3>
                        <div class="stat-row">
                            <span class="stat-label">Position</span>
                            <span id="position" class="stat-value">Center</span>
                        </div>
                        <button class="btn-secondary" onclick="resetCrosshair()" style="margin-top: 10px;">
                            üéØ Reset to Center
                        </button>
                    </div>

                    <div class="control-group">
                        <h3>‚ö° Performance</h3>
                        <div class="stat-row">
                            <span class="stat-label">Frame Rate</span>
                            <span id="fps" class="stat-value">-- FPS</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Exposure Time</span>
                            <span id="exp-time" class="stat-value">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Analog Gain</span>
                            <span id="gain" class="stat-value">--</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Digital Gain</span>
                            <span id="digital-gain" class="stat-value">--</span>
                        </div>
                    </div>
                </div>

                <!-- Camera Tracking Tab -->
                <div id="tracking-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üìπ Tracking Mode</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Choose how objects are tracked: move crosshair (software) or move camera (hardware)
                        </p>
                        
                        <div class="select-control">
                            <label>Tracking Mode</label>
                            <select id="tracking-mode" onchange="setTrackingMode()">
                                <option value="crosshair">Crosshair Tracking (Software)</option>
                                <option value="camera">Camera Tracking (Stepper Motors)</option>
                            </select>
                        </div>

                        <div id="tracking-mode-info" style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 6px; font-size: 13px; color: #1565c0;">
                            <strong>Crosshair Mode:</strong> Tracks objects by moving the crosshair on screen. Camera stays fixed.
                        </div>
                    </div>

                    <div id="camera-tracking-controls" style="display: none;">
                        <!-- Calibration Required Warning -->
                        <div id="calibration-required-warning" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                            <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Calibration Required</h3>
                            <p style="margin-bottom: 10px;">Camera tracking must be calibrated before use. Please run the Auto-Calibration sequence below.</p>
                            <p style="font-size: 12px; opacity: 0.9;">This only needs to be done once. Calibration data will be saved and reloaded on restart.</p>
                        </div>

                        <div class="control-group">
                            <h3>üéÆ Camera Control</h3>
                            
                            <div class="toggle-switch">
                                <label class="switch">
                                    <input type="checkbox" id="camera-tracking-enabled" onchange="toggleCameraTracking()">
                                    <span class="slider"></span>
                                </label>
                                <span class="toggle-label">Enable Camera Movement</span>
                            </div>

                            <button class="btn-primary" id="home-camera-btn" onclick="homeCameraPosition()" style="margin-top: 10px;">
                                üè† Home Camera to Center
                            </button>

                            <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
                                <strong>‚ö†Ô∏è Important:</strong> Ensure stepper motors are properly connected before enabling camera tracking.
                            </div>
                        </div>

                        <div class="control-group">
                            <h3>‚öôÔ∏è Camera Settings</h3>

                            <div class="slider-control">
                                <label>Dead Zone (pixels)</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="camera-dead-zone" min="5" max="100" value="20" step="5" oninput="updateCameraDeadZoneValue()">
                                    <span id="camera-dead-zone-value" class="slider-value">20px</span>
                                </div>
                            </div>

                            <div class="slider-control">
                                <label>Movement Speed</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="camera-step-delay" min="0.0005" max="0.005" value="0.001" step="0.0005" oninput="updateCameraStepDelayValue()">
                                    <span id="camera-step-delay-value" class="slider-value">1.0ms</span>
                                </div>
                            </div>

                            <button class="btn-primary" onclick="applyCameraTrackingSettings()">Apply Settings</button>
                        </div>

                        <div class="control-group">
                            <h3>üéØ Manual Position Control</h3>
                            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                                Manually adjust camera position with arrow controls
                            </p>

                            <div style="display: flex; flex-direction: column; align-items: center; gap: 5px; margin-bottom: 15px;">
                                <button class="btn-secondary" onclick="manualMove('y', -100)" style="width: 60px; padding: 8px;">‚ñ≤</button>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn-secondary" onclick="manualMove('x', -100)" style="width: 60px; padding: 8px;">‚óÑ</button>
                                    <button class="btn-secondary" onclick="setHomePosition()" style="width: 80px; padding: 8px; font-size: 11px;">üè† Set Home</button>
                                    <button class="btn-secondary" onclick="manualMove('x', 100)" style="width: 60px; padding: 8px;">‚ñ∫</button>
                                </div>
                                <button class="btn-secondary" onclick="manualMove('y', 100)" style="width: 60px; padding: 8px;">‚ñº</button>
                            </div>

                            <button class="btn-primary" onclick="homeCameraPosition()" style="width: 100%; margin-bottom: 15px;">
                                üè† Return to Home Position
                            </button>

                            <div class="slider-control">
                                <label>Step Size</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="manual-step-size" min="10" max="500" value="100" step="10" oninput="updateManualStepSize()">
                                    <span id="manual-step-size-value" class="slider-value">100</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <h3>üîß Calibration</h3>
                            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                                Automatically find limits and set home position, or manually calibrate steps-per-pixel
                            </p>

                            <button class="btn-success" onclick="runAutoCalibration()" style="margin-bottom: 15px;">
                                ü§ñ Auto-Calibrate & Home
                            </button>

                            <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 12px; color: #1565c0;">
                                <strong>Auto-Calibration:</strong> Finds movement limits in all directions, moves to center, and sets home position. May take several minutes.
                            </div>

                            <div class="slider-control">
                                <label>X-Axis Steps/Pixel</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="camera-x-steps-per-pixel" min="0.01" max="1.0" value="0.1" step="0.01" oninput="updateCameraXStepsValue()">
                                    <span id="camera-x-steps-value" class="slider-value">0.10</span>
                                </div>
                            </div>

                            <div class="slider-control">
                                <label>Y-Axis Steps/Pixel</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="camera-y-steps-per-pixel" min="0.01" max="1.0" value="0.1" step="0.01" oninput="updateCameraYStepsValue()">
                                    <span id="camera-y-steps-value" class="slider-value">0.10</span>
                                </div>
                            </div>

                            <button class="btn-primary" onclick="applyCameraCalibration()">Save Manual Calibration</button>
                        </div>

                        <div class="control-group">
                            <h3>üìä Camera Status</h3>
                            <div class="stat-row">
                                <span class="stat-label">System Status</span>
                                <span id="camera-system-status" class="stat-value">Initializing...</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Calibration Status</span>
                                <span id="camera-calibration-status" class="stat-value">Not Calibrated</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Camera Movement Enabled</span>
                                <span id="camera-enabled-status" class="stat-value">No</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Camera Position (X, Y)</span>
                                <span id="camera-position" class="stat-value">0, 0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Crosshair Position (X, Y)</span>
                                <span id="crosshair-position" class="stat-value">0, 0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Moving</span>
                                <span id="camera-moving" class="stat-value">No</span>
                            </div>
                        </div>
                    </div>

                    <div id="tracking-status-message" class="status-message"></div>
                </div>

                <!-- Laser Control Tab -->
                <div id="laser-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üî¥ Laser System</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="laser-enabled" onchange="toggleLaser()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Enable Laser System</span>
                        </div>

                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="auto-fire-enabled" onchange="toggleAutoFire()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto-Fire on Detection</span>
                        </div>

                        <button id="fire-button" class="btn-success" onclick="fireLaser()" style="font-size: 16px; padding: 15px;">
                            üî¥ FIRE LASER
                        </button>
                    </div>

                    <div class="control-group">
                        <h3>‚öôÔ∏è Fire Settings</h3>

                        <div class="slider-control">
                            <label>Pulse Duration (ms)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="pulse-duration" min="10" max="1000" value="100" step="10" oninput="updatePulseDurationValue()">
                                <span id="pulse-duration-value" class="slider-value">100ms</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Burst Count</label>
                            <div class="slider-wrapper">
                                <input type="range" id="burst-count" min="1" max="10" value="1" step="1" oninput="updateBurstCountValue()">
                                <span id="burst-count-value" class="slider-value">1</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Burst Delay (ms)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="burst-delay" min="50" max="1000" value="100" step="50" oninput="updateBurstDelayValue()">
                                <span id="burst-delay-value" class="slider-value">100ms</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Cooldown (seconds)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="laser-cooldown" min="0.1" max="5" value="0.5" step="0.1" oninput="updateLaserCooldownValue()">
                                <span id="laser-cooldown-value" class="slider-value">0.5s</span>
                            </div>
                        </div>

                        <button class="btn-primary" onclick="applyLaserSettings()">Apply Fire Settings</button>
                    </div>

                    <div class="control-group">
                        <h3>üìä Laser Status</h3>
                        <div class="stat-row">
                            <span class="stat-label">System Status</span>
                            <span id="laser-system-status" class="stat-value">OFF</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Ready to Fire</span>
                            <span id="laser-ready" class="stat-value">No</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Fires</span>
                            <span id="laser-fire-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Cooldown</span>
                            <span id="laser-cooldown-remaining" class="stat-value">Ready</span>
                        </div>
                        <button class="btn-secondary" onclick="resetFireCount()" style="margin-top: 10px;">
                            üîÑ Reset Counter
                        </button>
                    </div>

                    <div id="laser-status-message" class="status-message"></div>
                </div>

                <!-- Presets Tab -->
                <div id="presets-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üíæ Save Position</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Save current crosshair position to a slot (1-10)
                        </p>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="save-slot" min="1" max="10" value="1" 
                                   style="width: 60px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            <input type="text" id="preset-label" placeholder="Label (optional)" 
                                   style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>
                        <button class="btn-primary" onclick="savePreset()">üíæ Save to Slot</button>
                    </div>

                    <div class="control-group">
                        <h3>üìç Saved Positions</h3>
                        <div id="preset-list" style="max-height: 200px; overflow-y: auto;">
                            <p style="color: #999; text-align: center; padding: 20px;">No presets saved</p>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>üîÑ Pattern Sequence</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Execute sequence of saved positions
                        </p>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #555; font-weight: 600; margin-bottom: 8px; font-size: 13px;">
                                Sequence (comma-separated slots, e.g., 1,2,3,4)
                            </label>
                            <input type="text" id="pattern-sequence" placeholder="1,2,3,4" 
                                   style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>

                        <div class="slider-control">
                            <label>Delay Between Positions (seconds)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="pattern-delay" min="0.5" max="5" value="1" step="0.5" oninput="updatePatternDelayValue()">
                                <span id="pattern-delay-value" class="slider-value">1.0s</span>
                            </div>
                        </div>

                        <div class="toggle-switch" style="margin-bottom: 15px;">
                            <label class="switch">
                                <input type="checkbox" id="pattern-loop" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Loop Pattern</span>
                        </div>

                        <button id="start-pattern-btn" class="btn-success" onclick="startPattern()">
                            ‚ñ∂Ô∏è Start Pattern
                        </button>
                        <button id="stop-pattern-btn" class="btn-secondary" onclick="stopPattern()" style="display: none;">
                            ‚èπÔ∏è Stop Pattern
                        </button>
                    </div>

                    <div id="preset-status" class="status-message"></div>
                </div>

                <!-- Object Detection Tab -->
                <div id="object-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üë§ Object Detection</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="object-enabled" onchange="toggleObjectDetection()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Enable Object Detection</span>
                        </div>

                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="object-auto-track-enabled" onchange="toggleObjectAutoTrack()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto-Track Objects</span>
                        </div>

                        <div class="select-control">
                            <label>Detection Mode</label>
                            <select id="detection-mode" onchange="applyObjectSettings()">
                                <option value="face">Face Detection</option>
                                <option value="eye">Eye Detection</option>
                                <option value="body">Full Body Detection</option>
                                <option value="smile">Smile Detection</option>
                            </select>
                        </div>

                        <div class="select-control">
                            <label>Target Priority</label>
                            <select id="target-priority" onchange="applyObjectSettings()">
                                <option value="largest">Largest Object</option>
                                <option value="closest">Closest Object</option>
                                <option value="leftmost">Leftmost Object</option>
                                <option value="rightmost">Rightmost Object</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>üìä Detection Status</h3>
                        <div class="stat-row">
                            <span class="stat-label">Status</span>
                            <span id="object-status" class="stat-value">OFF</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Objects Detected</span>
                            <span id="objects-count" class="stat-value">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Current Mode</span>
                            <span id="current-mode" class="stat-value">Face</span>
                        </div>
                    </div>

                    <div id="object-status-message" class="status-message"></div>
                </div>

                <!-- Motion Detection Tab -->
                <div id="motion-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üéØ Motion Detection</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="motion-enabled" onchange="toggleMotionDetection()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Enable Motion Detection</span>
                        </div>

                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="auto-track-enabled" onchange="toggleAutoTrack()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto-Track Motion</span>
                        </div>

                        <div class="slider-control">
                            <label>Sensitivity (Lower = More Sensitive)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="motion-sensitivity" min="10" max="100" value="25" step="5" oninput="updateSensitivityValue()">
                                <span id="sensitivity-value" class="slider-value">25</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Minimum Area (pixels)</label>
                            <div class="slider-wrapper">
                                <input type="range" id="motion-min-area" min="100" max="5000" value="500" step="100" oninput="updateMinAreaValue()">
                                <span id="min-area-value" class="slider-value">500</span>
                            </div>
                        </div>

                        <button class="btn-primary" onclick="applyMotionSettings()">Apply Settings</button>
                    </div>

                    <div class="control-group">
                        <h3>üìä Motion Status</h3>
                        <div class="stat-row">
                            <span class="stat-label">Detection</span>
                            <span id="motion-status" class="stat-value">OFF</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Motion Detected</span>
                            <span id="motion-detected" class="stat-value">No</span>
                        </div>
                    </div>

                    <div id="motion-status-message" class="status-message"></div>
                </div>

                <!-- Exposure Tab -->
                <div id="exposure-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üîÜ Exposure Control</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="auto-exposure" checked onchange="toggleAutoExposure()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto Exposure</span>
                        </div>

                        <div id="manual-exposure-controls" style="display: none;">
                            <div class="slider-control">
                                <label>Exposure Time (¬µs)</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="exposure-time" min="1000" max="200000" value="20000" step="1000" oninput="updateExposureValue()">
                                    <span id="exposure-time-value" class="slider-value">20000</span>
                                </div>
                            </div>

                            <div class="slider-control">
                                <label>Analog Gain</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="analog-gain" min="1" max="16" value="1" step="0.1" oninput="updateAnalogGainValue()">
                                    <span id="analog-gain-value" class="slider-value">1.0</span>
                                </div>
                            </div>

                            <div class="slider-control">
                                <label>Digital Gain</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="digital-gain" min="1" max="8" value="1" step="0.1" oninput="updateDigitalGainValue()">
                                    <span id="digital-gain-value" class="slider-value">1.0</span>
                                </div>
                            </div>

                            <button class="btn-primary" onclick="applyExposure()">Apply Exposure Settings</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>‚öñÔ∏è White Balance</h3>
                        
                        <div class="toggle-switch">
                            <label class="switch">
                                <input type="checkbox" id="auto-wb" checked onchange="toggleAutoWB()">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Auto White Balance</span>
                        </div>

                        <div class="select-control" id="wb-mode-control" style="display: none;">
                            <label>WB Mode</label>
                            <select id="wb-mode" onchange="applyWhiteBalance()">
                                <option value="0">Auto</option>
                                <option value="1">Incandescent</option>
                                <option value="2">Tungsten</option>
                                <option value="3">Fluorescent</option>
                                <option value="4">Indoor</option>
                                <option value="5">Daylight</option>
                                <option value="6">Cloudy</option>
                            </select>
                        </div>
                    </div>

                    <div id="exposure-status" class="status-message"></div>
                </div>

                <!-- Image Tab -->
                <div id="image-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üé® Image Adjustments</h3>

                        <div class="slider-control">
                            <label>Brightness</label>
                            <div class="slider-wrapper">
                                <input type="range" id="brightness" min="-1" max="1" value="0" step="0.1" oninput="updateBrightnessValue()">
                                <span id="brightness-value" class="slider-value">0.0</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Contrast</label>
                            <div class="slider-wrapper">
                                <input type="range" id="contrast" min="0" max="2" value="1" step="0.1" oninput="updateContrastValue()">
                                <span id="contrast-value" class="slider-value">1.0</span>
                            </div>
                        </div>

                        <div class="slider-control">
                            <label>Saturation</label>
                            <div class="slider-wrapper">
                                <input type="range" id="saturation" min="0" max="2" value="1" step="0.1" oninput="updateSaturationValue()">
                                <span id="saturation-value" class="slider-value">1.0</span>
                            </div>
                        </div>

                        <button class="btn-primary" onclick="applyImageParams()">Apply Image Settings</button>
                        <button class="btn-secondary" onclick="resetImageParams()">Reset to Defaults</button>
                    </div>

                    <div id="image-status" class="status-message"></div>
                </div>

                <!-- Capture Tab -->
                <div id="capture-tab" class="tab-content">
                    <div class="control-group">
                        <h3>üì∏ Image Capture</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Capture high-quality still images from the camera feed.
                        </p>
                        <button class="btn-success" onclick="captureImage()">üì∑ Capture Image</button>
                    </div>

                    <div id="capture-status" class="status-message"></div>

                    <div class="control-group">
                        <h3>üé• Video Recording</h3>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                            Record live video feed to MP4 file with timestamp.
                        </p>
                        
                        <div id="recording-info" style="display: none; margin-bottom: 15px;">
                            <div class="stat-row">
                                <span class="stat-label">Status</span>
                                <span class="stat-value" style="color: #dc3545;">‚óè Recording</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Duration</span>
                                <span id="recording-duration" class="stat-value">00:00</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Filename</span>
                                <span id="recording-filename" class="stat-value" style="font-size: 11px;">--</span>
                            </div>
                        </div>

                        <button id="start-recording-btn" class="btn-primary" onclick="startRecording()">
                            ‚è∫Ô∏è Start Recording
                        </button>
                        <button id="stop-recording-btn" class="btn-secondary" onclick="stopRecording()" style="display: none;">
                            ‚èπÔ∏è Stop Recording
                        </button>
                    </div>

                    <div id="recording-status" class="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CAMERA_WIDTH = 1920;
        const CAMERA_HEIGHT = 1080;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        // Crosshair positioning with camera movement support
        document.getElementById('video-stream').addEventListener('click', function(e) {
            const rect = this.getBoundingClientRect();
            const scaleX = CAMERA_WIDTH / this.offsetWidth;
            const scaleY = CAMERA_HEIGHT / this.offsetHeight;
            const clickX = (e.clientX - rect.left);
            const clickY = (e.clientY - rect.top);
            const cameraX = Math.round(clickX * scaleX);
            const cameraY = Math.round(clickY * scaleY);
            
            // Check if camera tracking is enabled and active
            const trackingMode = document.getElementById('tracking-mode').value;
            const cameraTrackingEnabled = document.getElementById('camera-tracking-enabled').checked;
            
            if (trackingMode === 'camera' && cameraTrackingEnabled) {
                // Camera movement mode: move camera to recenter clicked position
                // Crosshair stays centered, don't update position display
                fetch('/tracking/camera/move_to_position', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x: cameraX, y: cameraY })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Visual feedback
                        showStatus('tracking-status-message', true, 'Camera moving to recenter position...');
                    } else {
                        showStatus('tracking-status-message', false, data.message);
                    }
                })
                .catch(error => {
                    console.error('Error moving camera to position:', error);
                    showStatus('tracking-status-message', false, 'Failed to move camera');
                });
            } else {
                // Crosshair mode: update crosshair position
                document.getElementById('position').textContent = `X: ${cameraX}, Y: ${cameraY}`;
                fetch('/update_crosshair', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x: cameraX, y: cameraY })
                });
            }
        });

        // Reset crosshair to center
        function resetCrosshair() {
            fetch('/reset_crosshair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('position').textContent = `X: ${data.x}, Y: ${data.y}`;
                }
            })
            .catch(error => console.error('Error resetting crosshair:', error));
        }

        // Exposure controls
        function toggleAutoExposure() {
            const autoEnabled = document.getElementById('auto-exposure').checked;
            document.getElementById('manual-exposure-controls').style.display = autoEnabled ? 'none' : 'block';
            fetch('/set_exposure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auto: autoEnabled })
            })
            .then(response => response.json())
            .then(data => showStatus('exposure-status', data.status === 'success', 
                autoEnabled ? 'Auto exposure enabled' : 'Manual exposure mode'));
        }

        function updateExposureValue() {
            const value = document.getElementById('exposure-time').value;
            document.getElementById('exposure-time-value').textContent = value;
        }

        function updateAnalogGainValue() {
            const value = parseFloat(document.getElementById('analog-gain').value).toFixed(1);
            document.getElementById('analog-gain-value').textContent = value;
        }

        function updateDigitalGainValue() {
            const value = parseFloat(document.getElementById('digital-gain').value).toFixed(1);
            document.getElementById('digital-gain-value').textContent = value;
        }

        function applyExposure() {
            const exposureTime = parseInt(document.getElementById('exposure-time').value);
            const analogGain = parseFloat(document.getElementById('analog-gain').value);
            const digitalGain = parseFloat(document.getElementById('digital-gain').value);
            fetch('/set_exposure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    auto: false,
                    exposure_time: exposureTime,
                    analog_gain: analogGain,
                    digital_gain: digitalGain
                })
            })
            .then(response => response.json())
            .then(data => showStatus('exposure-status', data.status === 'success', 
                data.status === 'success' ? 'Exposure settings applied' : data.message));
        }

        // White balance controls
        function toggleAutoWB() {
            const autoEnabled = document.getElementById('auto-wb').checked;
            document.getElementById('wb-mode-control').style.display = autoEnabled ? 'none' : 'block';
            fetch('/set_white_balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auto: autoEnabled })
            })
            .then(response => response.json())
            .then(data => showStatus('exposure-status', data.status === 'success',
                autoEnabled ? 'Auto white balance enabled' : 'Manual white balance mode'));
        }

        function applyWhiteBalance() {
            const mode = parseInt(document.getElementById('wb-mode').value);
            fetch('/set_white_balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auto: false, mode: mode })
            })
            .then(response => response.json())
            .then(data => showStatus('exposure-status', data.status === 'success',
                data.status === 'success' ? 'White balance applied' : data.message));
        }

        // Image adjustment controls
        function updateBrightnessValue() {
            const value = parseFloat(document.getElementById('brightness').value).toFixed(1);
            document.getElementById('brightness-value').textContent = value;
        }

        function updateContrastValue() {
            const value = parseFloat(document.getElementById('contrast').value).toFixed(1);
            document.getElementById('contrast-value').textContent = value;
        }

        function updateSaturationValue() {
            const value = parseFloat(document.getElementById('saturation').value).toFixed(1);
            document.getElementById('saturation-value').textContent = value;
        }

        function applyImageParams() {
            const brightness = parseFloat(document.getElementById('brightness').value);
            const contrast = parseFloat(document.getElementById('contrast').value);
            const saturation = parseFloat(document.getElementById('saturation').value);
            fetch('/set_image_params', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    brightness: brightness,
                    contrast: contrast,
                    saturation: saturation
                })
            })
            .then(response => response.json())
            .then(data => showStatus('image-status', data.status === 'success',
                data.status === 'success' ? 'Image settings applied' : data.message));
        }

        function resetImageParams() {
            document.getElementById('brightness').value = 0;
            document.getElementById('contrast').value = 1;
            document.getElementById('saturation').value = 1;
            updateBrightnessValue();
            updateContrastValue();
            updateSaturationValue();
            applyImageParams();
        }

        // Image capture
        function captureImage() {
            fetch('/capture_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => showStatus('capture-status', data.status === 'success',
                data.status === 'success' ? `Image saved: ${data.filename}` : data.message));
        }

        // Status message display
        function showStatus(elementId, success, message) {
            const statusEl = document.getElementById(elementId);
            statusEl.className = 'status-message ' + (success ? 'status-success' : 'status-error');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // Video recording controls
        function startRecording() {
            fetch('/start_recording', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('start-recording-btn').style.display = 'none';
                    document.getElementById('stop-recording-btn').style.display = 'block';
                    document.getElementById('recording-info').style.display = 'block';
                    document.getElementById('recording-filename').textContent = data.filename;
                    showStatus('recording-status', true, 'Recording started');
                } else {
                    showStatus('recording-status', false, data.message);
                }
            })
            .catch(error => {
                showStatus('recording-status', false, 'Failed to start recording');
                console.error('Error starting recording:', error);
            });
        }

        function stopRecording() {
            fetch('/stop_recording', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('start-recording-btn').style.display = 'block';
                    document.getElementById('stop-recording-btn').style.display = 'none';
                    document.getElementById('recording-info').style.display = 'none';
                    const duration = data.duration ? `${Math.floor(data.duration)}s` : '';
                    showStatus('recording-status', true, 
                        `Recording saved: ${data.filename} (${duration})`);
                } else {
                    showStatus('recording-status', false, data.message);
                }
            })
            .catch(error => {
                showStatus('recording-status', false, 'Failed to stop recording');
                console.error('Error stopping recording:', error);
            });
        }

        function updateRecordingStatus() {
            fetch('/recording_status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.is_recording) {
                        // Update duration display
                        const duration = Math.floor(data.duration);
                        const minutes = Math.floor(duration / 60);
                        const seconds = duration % 60;
                        document.getElementById('recording-duration').textContent = 
                            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        
                        // Ensure UI is in recording state
                        document.getElementById('start-recording-btn').style.display = 'none';
                        document.getElementById('stop-recording-btn').style.display = 'block';
                        document.getElementById('recording-info').style.display = 'block';
                        document.getElementById('recording-filename').textContent = data.filename;
                    }
                })
                .catch(error => console.error('Error checking recording status:', error));
        }

        // Laser control functions
        function toggleLaser() {
            const enabled = document.getElementById('laser-enabled').checked;
            fetch('/laser/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, 
                        enabled ? 'Laser system enabled' : 'Laser system disabled');
                    updateLaserStatus();
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to toggle laser');
                console.error('Error toggling laser:', error);
            });
        }

        function toggleAutoFire() {
            const enabled = document.getElementById('auto-fire-enabled').checked;
            fetch('/laser/auto_fire', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, 
                        enabled ? 'Auto-fire enabled' : 'Auto-fire disabled');
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to toggle auto-fire');
                console.error('Error toggling auto-fire:', error);
            });
        }

        function fireLaser() {
            const button = document.getElementById('fire-button');
            button.disabled = true;
            
            fetch('/laser/fire', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, data.message);
                    updateLaserStatus();
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
                setTimeout(() => { button.disabled = false; }, 100);
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to fire laser');
                console.error('Error firing laser:', error);
                button.disabled = false;
            });
        }

        function updatePulseDurationValue() {
            const value = document.getElementById('pulse-duration').value;
            document.getElementById('pulse-duration-value').textContent = value + 'ms';
        }

        function updateBurstCountValue() {
            const value = document.getElementById('burst-count').value;
            document.getElementById('burst-count-value').textContent = value;
        }

        function updateBurstDelayValue() {
            const value = document.getElementById('burst-delay').value;
            document.getElementById('burst-delay-value').textContent = value + 'ms';
        }

        function updateLaserCooldownValue() {
            const value = parseFloat(document.getElementById('laser-cooldown').value).toFixed(1);
            document.getElementById('laser-cooldown-value').textContent = value + 's';
        }

        function applyLaserSettings() {
            const pulseDuration = parseFloat(document.getElementById('pulse-duration').value) / 1000;
            const burstCount = parseInt(document.getElementById('burst-count').value);
            const burstDelay = parseFloat(document.getElementById('burst-delay').value) / 1000;
            const cooldown = parseFloat(document.getElementById('laser-cooldown').value);
            
            fetch('/laser/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pulse_duration: pulseDuration,
                    burst_count: burstCount,
                    burst_delay: burstDelay,
                    cooldown: cooldown
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, 'Laser settings applied');
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to apply laser settings');
                console.error('Error applying laser settings:', error);
            });
        }

        function updateLaserStatus() {
            fetch('/laser/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('laser-system-status').textContent = 
                            data.enabled ? 'ON' : 'OFF';
                        document.getElementById('laser-ready').textContent = 
                            data.ready_to_fire ? 'Yes' : 'No';
                        document.getElementById('laser-fire-count').textContent = 
                            data.fire_count;
                        
                        if (data.cooldown_remaining > 0) {
                            document.getElementById('laser-cooldown-remaining').textContent = 
                                data.cooldown_remaining.toFixed(1) + 's';
                        } else {
                            document.getElementById('laser-cooldown-remaining').textContent = 'Ready';
                        }
                        
                        // Sync UI with server state
                        document.getElementById('laser-enabled').checked = data.enabled;
                        document.getElementById('auto-fire-enabled').checked = data.auto_fire;
                        document.getElementById('pulse-duration').value = data.pulse_duration * 1000;
                        document.getElementById('burst-count').value = data.burst_count;
                        document.getElementById('burst-delay').value = data.burst_delay * 1000;
                        document.getElementById('laser-cooldown').value = data.cooldown;
                        
                        updatePulseDurationValue();
                        updateBurstCountValue();
                        updateBurstDelayValue();
                        updateLaserCooldownValue();
                        
                        // Update fire button state
                        document.getElementById('fire-button').disabled = !data.ready_to_fire || !data.enabled;
                    }
                })
                .catch(error => console.error('Error fetching laser status:', error));
        }

        function resetFireCount() {
            if (!confirm('Reset fire counter to 0?')) return;
            
            fetch('/laser/reset_count', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('laser-status-message', true, 'Fire counter reset');
                    updateLaserStatus();
                } else {
                    showStatus('laser-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('laser-status-message', false, 'Failed to reset counter');
                console.error('Error resetting counter:', error);
            });
        }

        // Preset position controls
        function savePreset() {
            const slot = parseInt(document.getElementById('save-slot').value);
            const label = document.getElementById('preset-label').value || `Preset ${slot}`;
            
            fetch('/presets/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ slot: slot, label: label })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('preset-status', true, `Saved to slot ${slot}`);
                    document.getElementById('preset-label').value = '';
                    loadPresetList();
                } else {
                    showStatus('preset-status', false, data.message);
                }
            })
            .catch(error => {
                showStatus('preset-status', false, 'Failed to save preset');
                console.error('Error saving preset:', error);
            });
        }

        function loadPreset(slot) {
            fetch(`/presets/load/${slot}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('preset-status', true, `Loaded ${data.label}`);
                    document.getElementById('position').textContent = `X: ${data.position.x}, Y: ${data.position.y}`;
                } else {
                    showStatus('preset-status', false, data.message);
                }
            })
            .catch(error => {
                showStatus('preset-status', false, 'Failed to load preset');
                console.error('Error loading preset:', error);
            });
        }

        function deletePreset(slot) {
            if (!confirm(`Delete preset ${slot}?`)) return;
            
            fetch(`/presets/delete/${slot}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('preset-status', true, `Deleted slot ${slot}`);
                    loadPresetList();
                } else {
                    showStatus('preset-status', false, data.message);
                }
            })
            .catch(error => {
                showStatus('preset-status', false, 'Failed to delete preset');
                console.error('Error deleting preset:', error);
            });
        }

        function loadPresetList() {
            fetch('/presets/list')
                .then(response => response.json())
                .then(data => {
                    const listEl = document.getElementById('preset-list');
                    const presets = data.presets;
                    
                    if (Object.keys(presets).length === 0) {
                        listEl.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No presets saved</p>';
                        return;
                    }
                    
                    let html = '';
                    for (const [slot, preset] of Object.entries(presets).sort((a, b) => a[0] - b[0])) {
                        html += `
                            <div class="preset-item">
                                <div class="preset-info">
                                    <div><span class="preset-slot">#${slot}</span> <span class="preset-label">${preset.label}</span></div>
                                    <div class="preset-coords">X: ${preset.x}, Y: ${preset.y}</div>
                                </div>
                                <div class="preset-actions">
                                    <button class="preset-btn preset-btn-load" onclick="loadPreset(${slot})">Load</button>
                                    <button class="preset-btn preset-btn-delete" onclick="deletePreset(${slot})">Delete</button>
                                </div>
                            </div>
                        `;
                    }
                    listEl.innerHTML = html;
                })
                .catch(error => console.error('Error loading preset list:', error));
        }

        function updatePatternDelayValue() {
            const value = parseFloat(document.getElementById('pattern-delay').value).toFixed(1);
            document.getElementById('pattern-delay-value').textContent = value + 's';
        }

        function startPattern() {
            const sequenceStr = document.getElementById('pattern-sequence').value;
            const delay = parseFloat(document.getElementById('pattern-delay').value);
            const loop = document.getElementById('pattern-loop').checked;
            
            // Parse sequence
            const sequence = sequenceStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            
            if (sequence.length === 0) {
                showStatus('preset-status', false, 'Enter a valid sequence');
                return;
            }
            
            fetch('/presets/pattern/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sequence: sequence, delay: delay, loop: loop })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('preset-status', true, 'Pattern started');
                    document.getElementById('start-pattern-btn').style.display = 'none';
                    document.getElementById('stop-pattern-btn').style.display = 'block';
                } else {
                    showStatus('preset-status', false, data.message);
                }
            })
            .catch(error => {
                showStatus('preset-status', false, 'Failed to start pattern');
                console.error('Error starting pattern:', error);
            });
        }

        function stopPattern() {
            fetch('/presets/pattern/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('preset-status', true, 'Pattern stopped');
                    document.getElementById('start-pattern-btn').style.display = 'block';
                    document.getElementById('stop-pattern-btn').style.display = 'none';
                } else {
                    showStatus('preset-status', false, data.message);
                }
            })
            .catch(error => {
                showStatus('preset-status', false, 'Failed to stop pattern');
                console.error('Error stopping pattern:', error);
            });
        }

        function updatePatternStatus() {
            fetch('/presets/pattern/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.running) {
                        document.getElementById('start-pattern-btn').style.display = 'none';
                        document.getElementById('stop-pattern-btn').style.display = 'block';
                    } else {
                        document.getElementById('start-pattern-btn').style.display = 'block';
                        document.getElementById('stop-pattern-btn').style.display = 'none';
                    }
                })
                .catch(error => console.error('Error checking pattern status:', error));
        }

        // Keyboard shortcuts for presets (1-9, 0 for slot 10)
        document.addEventListener('keydown', function(e) {
            // Only trigger if not typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            const key = e.key;
            if (key >= '1' && key <= '9') {
                const slot = parseInt(key);
                loadPreset(slot);
                e.preventDefault();
            } else if (key === '0') {
                loadPreset(10);
                e.preventDefault();
            }
        });

        // Object detection controls
        function toggleObjectDetection() {
            const enabled = document.getElementById('object-enabled').checked;
            fetch('/object_detection/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('object-status-message', true, 
                        enabled ? 'Object detection enabled' : 'Object detection disabled');
                    updateObjectStatus();
                } else {
                    showStatus('object-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('object-status-message', false, 'Failed to toggle object detection');
                console.error('Error toggling object detection:', error);
            });
        }

        function toggleObjectAutoTrack() {
            const enabled = document.getElementById('object-auto-track-enabled').checked;
            fetch('/object_detection/auto_track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('object-status-message', true, 
                        enabled ? 'Object auto-tracking enabled' : 'Object auto-tracking disabled');
                } else {
                    showStatus('object-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('object-status-message', false, 'Failed to toggle object auto-track');
                console.error('Error toggling object auto-track:', error);
            });
        }

        function applyObjectSettings() {
            const mode = document.getElementById('detection-mode').value;
            const priority = document.getElementById('target-priority').value;
            
            fetch('/object_detection/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mode: mode,
                    priority: priority
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('object-status-message', true, 'Object detection settings applied');
                    updateObjectStatus();
                } else {
                    showStatus('object-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('object-status-message', false, 'Failed to apply object settings');
                console.error('Error applying object settings:', error);
            });
        }

        function updateObjectStatus() {
            fetch('/object_detection/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('object-status').textContent = 
                            data.enabled ? 'ON' : 'OFF';
                        document.getElementById('objects-count').textContent = 
                            data.objects_detected;
                        document.getElementById('current-mode').textContent = 
                            data.mode.charAt(0).toUpperCase() + data.mode.slice(1);
                        
                        // Sync UI with server state
                        document.getElementById('object-enabled').checked = data.enabled;
                        document.getElementById('object-auto-track-enabled').checked = data.auto_track;
                        document.getElementById('detection-mode').value = data.mode;
                        document.getElementById('target-priority').value = data.priority;
                    }
                })
                .catch(error => console.error('Error fetching object status:', error));
        }

        // Motion detection controls
        function toggleMotionDetection() {
            const enabled = document.getElementById('motion-enabled').checked;
            fetch('/motion_detection/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('motion-status-message', true, 
                        enabled ? 'Motion detection enabled' : 'Motion detection disabled');
                    updateMotionStatus();
                } else {
                    showStatus('motion-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('motion-status-message', false, 'Failed to toggle motion detection');
                console.error('Error toggling motion detection:', error);
            });
        }

        function toggleAutoTrack() {
            const enabled = document.getElementById('auto-track-enabled').checked;
            fetch('/motion_detection/auto_track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('motion-status-message', true, 
                        enabled ? 'Auto-tracking enabled' : 'Auto-tracking disabled');
                } else {
                    showStatus('motion-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('motion-status-message', false, 'Failed to toggle auto-track');
                console.error('Error toggling auto-track:', error);
            });
        }

        function updateSensitivityValue() {
            const value = document.getElementById('motion-sensitivity').value;
            document.getElementById('sensitivity-value').textContent = value;
        }

        function updateMinAreaValue() {
            const value = document.getElementById('motion-min-area').value;
            document.getElementById('min-area-value').textContent = value;
        }

        function applyMotionSettings() {
            const sensitivity = parseInt(document.getElementById('motion-sensitivity').value);
            const minArea = parseInt(document.getElementById('motion-min-area').value);
            
            fetch('/motion_detection/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sensitivity: sensitivity,
                    min_area: minArea
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('motion-status-message', true, 'Motion settings applied');
                    syncMotionSliders(); // Sync sliders after successful apply
                } else {
                    showStatus('motion-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('motion-status-message', false, 'Failed to apply motion settings');
                console.error('Error applying motion settings:', error);
            });
        }

        function updateMotionStatus() {
            fetch('/motion_detection/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('motion-status').textContent = 
                            data.enabled ? 'ON' : 'OFF';
                        document.getElementById('motion-detected').textContent = 
                            data.motion_detected ? 'Yes' : 'No';
                        
                        // Sync toggles with server state
                        document.getElementById('motion-enabled').checked = data.enabled;
                        document.getElementById('auto-track-enabled').checked = data.auto_track;
                        
                        // Don't sync sliders here - let user adjust them before applying
                        // Only sync sliders on page load or after applying settings
                    }
                })
                .catch(error => console.error('Error fetching motion status:', error));
        }
        
        function syncMotionSliders() {
            // Sync motion sliders with server state (called on page load only)
            fetch('/motion_detection/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('motion-sensitivity').value = data.sensitivity;
                        document.getElementById('motion-min-area').value = data.min_area;
                        updateSensitivityValue();
                        updateMinAreaValue();
                    }
                })
                .catch(error => console.error('Error fetching motion status:', error));
        }

        // Update crosshair position display
        function updateCrosshairPosition() {
            fetch('/get_crosshair_position')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('crosshair-position').textContent = 
                            `${data.relative_x}, ${data.relative_y}`;
                    }
                })
                .catch(error => console.error('Error fetching crosshair position:', error));
        }

        // Update stats periodically
        function updateStats() {
            fetch('/exposure_stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('exp-time').textContent = 
                        `${(data.exposure_time/1000).toFixed(1)} ms`;
                    document.getElementById('gain').textContent = 
                        `${data.analog_gain.toFixed(2)}x`;
                });

            fetch('/get_fps')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('fps').textContent = `${data.fps} FPS`;
                });

            fetch('/get_camera_settings')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('digital-gain').textContent = 
                            `${data.settings.digital_gain.toFixed(2)}x`;
                    }
                });
            
            // Update recording status if on capture tab
            updateRecordingStatus();
            
            // Update laser status
            updateLaserStatus();
            
            // Update object detection status
            updateObjectStatus();
            
            // Update motion detection status
            updateMotionStatus();
            
            // Update pattern status
            updatePatternStatus();
            
            // Update crosshair position
            updateCrosshairPosition();
        }

        // Camera tracking controls
        function setTrackingMode() {
            const mode = document.getElementById('tracking-mode').value;
            
            fetch('/tracking/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateTrackingModeUI(mode);
                    showStatus('tracking-status-message', true, 
                        mode === 'crosshair' ? 'Crosshair tracking mode active' : 'Camera tracking mode active');
                    updateCameraTrackingStatus();
                } else {
                    showStatus('tracking-status-message', false, data.message);
                    // Revert to previous mode on error
                    document.getElementById('tracking-mode').value = 
                        mode === 'crosshair' ? 'camera' : 'crosshair';
                }
            })
            .catch(error => {
                showStatus('tracking-status-message', false, 'Failed to set tracking mode');
                console.error('Error setting tracking mode:', error);
            });
        }

        function updateTrackingModeUI(mode) {
            const cameraControls = document.getElementById('camera-tracking-controls');
            const infoBox = document.getElementById('tracking-mode-info');
            
            if (mode === 'camera') {
                cameraControls.style.display = 'block';
                infoBox.innerHTML = '<strong>Camera Mode:</strong> Physically moves the camera with stepper motors to keep objects centered. Crosshair stays fixed.';
                infoBox.style.background = '#fff3cd';
                infoBox.style.color = '#856404';
            } else {
                cameraControls.style.display = 'none';
                infoBox.innerHTML = '<strong>Crosshair Mode:</strong> Tracks objects by moving the crosshair on screen. Camera stays fixed.';
                infoBox.style.background = '#e3f2fd';
                infoBox.style.color = '#1565c0';
            }
        }

        function toggleCameraTracking() {
            const enabled = document.getElementById('camera-tracking-enabled').checked;
            
            fetch('/tracking/camera/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('tracking-status-message', true, 
                        enabled ? 'Camera tracking enabled' : 'Camera tracking disabled');
                    updateCameraTrackingStatus();
                } else {
                    showStatus('tracking-status-message', false, data.message);
                    document.getElementById('camera-tracking-enabled').checked = !enabled;
                }
            })
            .catch(error => {
                showStatus('tracking-status-message', false, 'Failed to toggle camera tracking');
                console.error('Error toggling camera tracking:', error);
                document.getElementById('camera-tracking-enabled').checked = !enabled;
            });
        }

        function homeCameraPosition() {
            fetch('/tracking/camera/home', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('tracking-status-message', true, 'Homing camera to center position...');
                    setTimeout(updateCameraTrackingStatus, 1000);
                } else {
                    showStatus('tracking-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('tracking-status-message', false, 'Failed to home camera');
                console.error('Error homing camera:', error);
            });
        }

        function updateCameraDeadZoneValue() {
            const value = document.getElementById('camera-dead-zone').value;
            document.getElementById('camera-dead-zone-value').textContent = value + 'px';
        }

        function updateCameraStepDelayValue() {
            const value = parseFloat(document.getElementById('camera-step-delay').value);
            document.getElementById('camera-step-delay-value').textContent = (value * 1000).toFixed(1) + 'ms';
        }

        // Track whether calibration sliders have been initialized from server
        let calibrationSlidersInitialized = false;

        function updateCameraXStepsValue() {
            const value = parseFloat(document.getElementById('camera-x-steps-per-pixel').value).toFixed(2);
            document.getElementById('camera-x-steps-value').textContent = value;
        }

        function updateCameraYStepsValue() {
            const value = parseFloat(document.getElementById('camera-y-steps-per-pixel').value).toFixed(2);
            document.getElementById('camera-y-steps-value').textContent = value;
        }

        function applyCameraTrackingSettings() {
            const deadZone = parseInt(document.getElementById('camera-dead-zone').value);
            const stepDelay = parseFloat(document.getElementById('camera-step-delay').value);
            
            fetch('/tracking/camera/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dead_zone_pixels: deadZone,
                    step_delay: stepDelay
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('tracking-status-message', true, 'Camera tracking settings applied');
                } else {
                    showStatus('tracking-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('tracking-status-message', false, 'Failed to apply settings');
                console.error('Error applying camera settings:', error);
            });
        }

        function applyCameraCalibration() {
            const xSteps = parseFloat(document.getElementById('camera-x-steps-per-pixel').value);
            const ySteps = parseFloat(document.getElementById('camera-y-steps-per-pixel').value);
            
            fetch('/tracking/camera/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    x_steps_per_pixel: xSteps,
                    y_steps_per_pixel: ySteps
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('tracking-status-message', true, 'Calibration saved');
                } else {
                    showStatus('tracking-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('tracking-status-message', false, 'Failed to save calibration');
                console.error('Error saving calibration:', error);
            });
        }

        function updateManualStepSize() {
            const value = document.getElementById('manual-step-size').value;
            document.getElementById('manual-step-size-value').textContent = value;
        }

        function manualMove(axis, steps) {
            // Use the step size from slider instead of hardcoded value
            const stepSize = parseInt(document.getElementById('manual-step-size').value);
            const actualSteps = steps > 0 ? stepSize : -stepSize;
            
            fetch('/tracking/camera/manual_move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    axis: axis,
                    steps: actualSteps
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('tracking-status-message', true, data.message);
                } else {
                    showStatus('tracking-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('tracking-status-message', false, 'Failed to move camera');
                console.error('Error moving camera:', error);
            });
        }

        function setHomePosition() {
            if (!confirm('Set current position as home (0, 0)?')) return;
            
            fetch('/tracking/camera/set_home', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('tracking-status-message', true, data.message);
                    updateCameraTrackingStatus();
                } else {
                    showStatus('tracking-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('tracking-status-message', false, 'Failed to set home position');
                console.error('Error setting home position:', error);
            });
        }

        function runAutoCalibration() {
            if (!confirm('Run automatic calibration? This will move the camera through its full range of motion and may take several minutes. Ensure the area is clear.')) return;
            
            fetch('/tracking/camera/auto_calibrate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('tracking-status-message', true, data.message);
                    // Poll status more frequently during calibration
                    setTimeout(() => {
                        updateCameraTrackingStatus();
                    }, 5000);
                } else {
                    showStatus('tracking-status-message', false, data.message);
                }
            })
            .catch(error => {
                showStatus('tracking-status-message', false, 'Failed to start auto-calibration');
                console.error('Error starting auto-calibration:', error);
            });
        }

        function updateCalibrationUI(isCalibrated, timestamp) {
            // Update calibration status display
            if (isCalibrated) {
                document.getElementById('camera-calibration-status').textContent = 'Calibrated ‚úì';
                document.getElementById('camera-calibration-status').style.color = '#28a745';
                document.getElementById('calibration-required-warning').style.display = 'none';
                
                // Enable controls
                document.getElementById('camera-tracking-enabled').disabled = false;
                document.getElementById('home-camera-btn').disabled = false;
                
                // Enable manual control buttons
                document.querySelectorAll('[onclick^="manualMove"]').forEach(btn => {
                    btn.disabled = false;
                });
                document.querySelectorAll('[onclick="setHomePosition()"]').forEach(btn => {
                    btn.disabled = false;
                });
                document.querySelectorAll('[onclick="homeCameraPosition()"]').forEach(btn => {
                    btn.disabled = false;
                });
            } else {
                document.getElementById('camera-calibration-status').textContent = 'Not Calibrated';
                document.getElementById('camera-calibration-status').style.color = '#dc3545';
                document.getElementById('calibration-required-warning').style.display = 'block';
                
                // Disable controls
                document.getElementById('camera-tracking-enabled').disabled = true;
                document.getElementById('camera-tracking-enabled').checked = false;
                document.getElementById('home-camera-btn').disabled = true;
                
                // Disable manual control buttons
                document.querySelectorAll('[onclick^="manualMove"]').forEach(btn => {
                    btn.disabled = true;
                });
                document.querySelectorAll('[onclick="setHomePosition()"]').forEach(btn => {
                    btn.disabled = true;
                });
                document.querySelectorAll('[onclick="homeCameraPosition()"]').forEach(btn => {
                    btn.disabled = true;
                });
            }
        }

        function updateCameraTrackingStatus() {
            fetch('/tracking/camera/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update tracking mode dropdown if needed
                        if (data.mode) {
                            document.getElementById('tracking-mode').value = data.mode;
                            updateTrackingModeUI(data.mode);
                        }
                        
                        if (data.available) {
                            document.getElementById('camera-system-status').textContent = 'Available';
                            document.getElementById('camera-enabled-status').textContent = 
                                data.enabled ? 'Yes' : 'No';
                            
                            const controller = data.controller_status;
                            if (controller) {
                                document.getElementById('camera-position').textContent = 
                                    `${controller.position.x}, ${controller.position.y}`;
                                document.getElementById('camera-moving').textContent = 
                                    controller.moving ? 'Yes' : 'No';
                                
                                // Update crosshair position
                                updateCrosshairPosition();
                                
                                // Initialize calibration sliders ONLY on first load
                                // After that, preserve user's values until they save or refresh page
                                if (controller.calibration && !calibrationSlidersInitialized) {
                                    document.getElementById('camera-x-steps-per-pixel').value = 
                                        controller.calibration.x_steps_per_pixel;
                                    document.getElementById('camera-x-steps-value').textContent = 
                                        controller.calibration.x_steps_per_pixel.toFixed(2);
                                    
                                    document.getElementById('camera-y-steps-per-pixel').value = 
                                        controller.calibration.y_steps_per_pixel;
                                    document.getElementById('camera-y-steps-value').textContent = 
                                        controller.calibration.y_steps_per_pixel.toFixed(2);
                                    
                                    document.getElementById('camera-dead-zone').value = 
                                        controller.calibration.dead_zone_pixels;
                                    updateCameraDeadZoneValue();
                                    
                                    // Mark as initialized so we don't overwrite user changes
                                    calibrationSlidersInitialized = true;
                                }
                                
                                // Update calibration status UI
                                if (controller.calibration) {
                                    updateCalibrationUI(
                                        controller.calibration.is_calibrated,
                                        controller.calibration.calibration_timestamp
                                    );
                                }
                            }
                            
                            document.getElementById('camera-tracking-enabled').checked = data.enabled;
                        } else {
                            document.getElementById('camera-system-status').textContent = 'Not Available';
                            document.getElementById('camera-enabled-status').textContent = 'N/A';
                        }
                    }
                })
                .catch(error => console.error('Error fetching camera tracking status:', error));
        }

        // Load presets on page load
        loadPresetList();
        
        // Sync motion sliders on page load
        syncMotionSliders();
        
        // Initialize camera tracking status
        updateCameraTrackingStatus();
        
        setInterval(updateStats, 1000);
        
        // Update camera tracking status every 2 seconds
        setInterval(updateCameraTrackingStatus, 2000);
        
        updateStats();
    </script>
</body>
</html>
